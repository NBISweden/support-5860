<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Combined • Integration</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="assets/report.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
#TOC {
  display: none !important;
}
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"><b>NBIS • Support 5860</b></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/nbisweden/support-5860">
    <span class="fa fa-github"></span>
     
    GitHub
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Combined • Integration</h1>
<h3 class="subtitle">10-Jan-2022</h3>

</div>


<!-- rmd lab header -->
<p><br></p>
<p><br></p>
<div class="boxy">
<p><strong>NBIS ID:</strong> 5860<br />
<strong>Report Version:</strong> 1.1<br />
<strong>Request by:</strong> Taija Mäkinen (<a href="mailto:taija.makinen@igp.uu.se" class="email">taija.makinen@igp.uu.se</a>)<br />
<strong>Principal Investigator:</strong> Taija Makinen (<a href="mailto:taija.makinen@igp.uu.se" class="email">taija.makinen@igp.uu.se</a>)<br />
<strong>Organisation:</strong> Uppsala University<br />
<strong>NBIS Staff:</strong> Roy Francis (<a href="mailto:roy.francis@nbis.se" class="email">roy.francis@nbis.se</a>)</p>
</div>
<p><br></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="do">## LIBRARIES</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Seurat)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># CUSTOM VARIABLES</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># custom ggplot theme</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>theme_report <span class="ot">&lt;-</span> <span class="cf">function</span> (<span class="at">basesize=</span><span class="dv">12</span>,<span class="at">basefamily=</span><span class="st">&quot;Barlow&quot;</span>) {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size=</span>basesize,<span class="at">base_family=</span>basefamily) <span class="sc">%+replace%</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.border=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.grid.minor=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.grid.major.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.position=</span><span class="st">&quot;top&quot;</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.direction=</span><span class="st">&quot;horizontal&quot;</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.justification=</span><span class="st">&quot;center&quot;</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">strip.background=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.ticks.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.ticks.x=</span><span class="fu">element_line</span>(<span class="at">colour=</span><span class="st">&quot;grey60&quot;</span>),</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.caption=</span><span class="fu">element_text</span>(<span class="at">hjust=</span><span class="dv">0</span>,<span class="at">colour=</span><span class="st">&quot;grey60&quot;</span>,<span class="at">size=</span><span class="dv">10</span>),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title=</span><span class="fu">element_text</span>(<span class="at">colour=</span><span class="st">&quot;grey60&quot;</span>,<span class="at">hjust=</span><span class="fl">0.5</span>),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle=</span><span class="fu">element_text</span>(<span class="at">colour=</span><span class="st">&quot;grey60&quot;</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># custom ggplot theme</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>theme_simple <span class="ot">&lt;-</span> <span class="cf">function</span> (<span class="at">basesize=</span><span class="dv">12</span>,<span class="at">basefamily=</span><span class="st">&quot;Barlow&quot;</span>) {</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size=</span>basesize,<span class="at">base_family=</span>basefamily) <span class="sc">%+replace%</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme</span>(</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.border=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">panel.grid=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.justification=</span><span class="st">&quot;right&quot;</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>            <span class="at">strip.background=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.ticks=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.text=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.title=</span><span class="fu">element_blank</span>(),</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.caption=</span><span class="fu">element_text</span>(<span class="at">hjust=</span><span class="dv">0</span>,<span class="at">colour=</span><span class="st">&quot;grey60&quot;</span>,<span class="at">size=</span><span class="dv">10</span>),</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title=</span><span class="fu">element_text</span>(<span class="at">colour=</span><span class="st">&quot;grey60&quot;</span>),</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle=</span><span class="fu">element_text</span>(<span class="at">colour=</span><span class="st">&quot;grey60&quot;</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>execute <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;functions.R&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(future)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># initialiase future</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.1 gb per core</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">future.globals.maxSize=</span>(<span class="fl">3.1</span><span class="sc">*</span> <span class="dv">1000</span> <span class="sc">*</span> <span class="dv">1024</span><span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plan</span>(<span class="st">&quot;multiprocess&quot;</span>, <span class="at">workers=</span><span class="dv">10</span>)</span></code></pre></div>
<div id="updates" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Updates</h1>
<div id="nov-2021" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> 08-Nov-2021</h2>
<ul>
<li>Fixed discrepancy in cluster labels between umap plots and other results.</li>
</ul>
</div>
<div id="nov-2021-1" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> 04-Nov-2021</h2>
<ul>
<li>Added UMAP plots with clusters</li>
</ul>
</div>
<div id="nov-2021-2" class="section level2" number="1.3">
<h2><span class="header-section-number">1.3</span> 01-Nov-2021</h2>
<ul>
<li>Clean-up of data before integration step
<ul>
<li>keep cells with &gt;= 200 genes and &lt;= 6000 and mito &lt; 5%</li>
<li>keep genes with &gt;= 10 cells</li>
<li>remove all mitochondrial genes</li>
<li>remove all ribosomal genes</li>
</ul></li>
<li>706 custom selected cells were discarded</li>
</ul>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["cells"],"name":[1],"type":["chr"],"align":["left"]}],"data":[{"1":"AATGAAGAGGATATGT_3"},{"1":"AATTCCTGTCTAGGCC_3"},{"1":"ACATCGACACGACGTC_3"},{"1":"ACCCTTGCAGGCGTTC_3"},{"1":"ACGGTCGAGCAGGGAG_3"},{"1":"ACTATGGCATTGGCAT_3"},{"1":"AGAAGTAAGTACCCTA_3"},{"1":"AGACCCGCATGAAGCG_3"},{"1":"AGAGAATAGGCATTTC_3"},{"1":"AGGCTGCGTGCGAACA_3"},{"1":"AGGGTCCTCATTACTC_3"},{"1":"AGTAGTCCAAGCCTGC_3"},{"1":"ATACCGAAGTATAGAC_3"},{"1":"ATCCTATTCCGCGGAT_3"},{"1":"ATCGTGAGTCCAGAAG_3"},{"1":"ATGGAGGAGAAGCTGC_3"},{"1":"ATTCACTCAGCCCACA_3"},{"1":"ATTCCATAGGCGTTAG_3"},{"1":"ATTTACCCAGCAAGAC_3"},{"1":"CAACGGCTCTCGTCAC_3"},{"1":"CACGAATGTTGCATGT_3"},{"1":"CACTGAAGTGGTAATA_3"},{"1":"CACTGTCGTCCAGAAG_3"},{"1":"CAGATTGGTTTACCAG_3"},{"1":"CATGCCTGTGGTACAG_3"},{"1":"CATGCTCAGTGCACCC_3"},{"1":"CATGCTCTCCCATGGG_3"},{"1":"CATGCTCTCGTTCTCG_3"},{"1":"CATGGATAGGCTCACC_3"},{"1":"CCCGGAAAGGTTCTAC_3"},{"1":"CCCGGAATCGAACCAT_3"},{"1":"CCGGACAAGTATAGAC_3"},{"1":"CCTAACCTCTCATTAC_3"},{"1":"CCTCATGTCCAACTAG_3"},{"1":"CCTGTTGTCGACATAC_3"},{"1":"CGATGGCTCTTCTGTA_3"},{"1":"CTACATTTCTACTGCC_3"},{"1":"CTAGACACAGGCAATG_3"},{"1":"CTCAGTCGTCAGTCTA_3"},{"1":"CTCATCGTCGCTTGAA_3"},{"1":"CTGCGAGAGCATGAAT_3"},{"1":"CTTGATTAGTTAACAG_3"},{"1":"GACGCTGAGTAGAGTT_3"},{"1":"GACGCTGCACGCTTAA_3"},{"1":"GACGTTACAAGGCCTC_3"},{"1":"GACTCAACAGGGATAC_3"},{"1":"GAGAAATTCAGGACAG_3"},{"1":"GAGGCAAGTAGTCTGT_3"},{"1":"GAGTTACCAAACAGGC_3"},{"1":"GATGCTATCGAACCAT_3"},{"1":"GCATCTCGTTGCTAGT_3"},{"1":"GCCAGCACAATTCGTG_3"},{"1":"GCGTTTCCAGCGACCT_3"},{"1":"GCTGAATAGTCCTGCG_3"},{"1":"GCTTCACCATCGGCCA_3"},{"1":"GGCAGTCAGGATTTGA_3"},{"1":"GGGACCTTCGACCCAG_3"},{"1":"GGGACCTTCGTTCAGA_3"},{"1":"GGGTGTCCATGGGCAA_3"},{"1":"GGGTGTCTCCAAGGGA_3"},{"1":"GGTGATTGTTCCGCTT_3"},{"1":"GGTGTCGGTATGGGAC_3"},{"1":"GGTTGTAAGGTGATAT_3"},{"1":"GTAACCAAGGTATCTC_3"},{"1":"GTAACCAGTATGAGGC_3"},{"1":"GTACAACTCATACGGT_3"},{"1":"GTCGTAAAGTAACGTA_3"},{"1":"GTGAGCCCATCCTCAC_3"},{"1":"GTGAGTTCAACTACGT_3"},{"1":"GTGGAAGAGTAGGCCA_3"},{"1":"GTGGAAGGTTCGGTTA_3"},{"1":"TAGGGTTTCCGATAGT_3"},{"1":"TCAATTCGTCTAATCG_3"},{"1":"TCACGGGTCGTCGACG_3"},{"1":"TCATGGACACCCTATC_3"},{"1":"TCCGATCGTTGGTAGG_3"},{"1":"TCGCTTGCAGCAGTTT_3"},{"1":"TGCTTCGCAACTGCCG_3"},{"1":"TGGTACATCACAATGC_3"},{"1":"TGGTGATGTTGCCGAC_3"},{"1":"TGTAGACGTGAGCAGT_3"},{"1":"TGTCCCAAGTGATGGC_3"},{"1":"TGTTGGACAAGCCATT_3"},{"1":"TTACTGTCACTGTGTA_3"},{"1":"TTCATGTGTCCAGCAC_3"},{"1":"TTTACGTCAGGTCCCA_3"},{"1":"TTTATGCCACCGTGGT_3"},{"1":"TTTCACACAGTCGGTC_3"},{"1":"AAACCCACAGAGCCCT_4"},{"1":"ACATCGATCGCTCCTA_4"},{"1":"ACGGTTATCCGGCAAC_4"},{"1":"ACTGTGAAGGAACTAT_4"},{"1":"ACTTCGCCAATCGAAA_4"},{"1":"AGGGCTCGTAGAGCTG_4"},{"1":"AGGTCATCACTACCGG_4"},{"1":"AGTCATGGTGTTCCTC_4"},{"1":"AGTGTTGGTGTTACTG_4"},{"1":"ATCCCTGAGCGTCTCG_4"},{"1":"ATCGCCTGTGTCATCA_4"},{"1":"ATCGGATCAATCGCGC_4"},{"1":"ATGATCGAGCGTGAAC_4"},{"1":"ATGTCTTTCCGATCGG_4"},{"1":"ATTACCTGTCCCAAAT_4"},{"1":"ATTCGTTGTATCGCTA_4"},{"1":"ATTCTACAGAAGCTCG_4"},{"1":"ATTCTTGAGCAATAGT_4"},{"1":"ATTGTTCGTCTGTGAT_4"},{"1":"ATTTACCCATCCTTGC_4"},{"1":"CAAGAGGCAGATACCT_4"},{"1":"CAAGGGAAGTCCCAGC_4"},{"1":"CAGCAATAGCCAAGGT_4"},{"1":"CCAATTTAGCTGTTCA_4"},{"1":"CCACCATTCGAGTCTA_4"},{"1":"CCGGTAGCAATAGGGC_4"},{"1":"CCTGTTGTCACCATGA_4"},{"1":"CGACAGCTCCGATAAC_4"},{"1":"CGAGGAAAGGGCAACT_4"},{"1":"CGTGAATTCGCAGTTA_4"},{"1":"CTAACCCAGACCTCAT_4"},{"1":"CTAACCCTCCCGAAAT_4"},{"1":"CTACCCAGTGCTTATG_4"},{"1":"CTCAACCGTCTTCATT_4"},{"1":"CTCAGTCAGCCTTGAT_4"},{"1":"CTCATCGAGAGCAACC_4"},{"1":"CTCATCGGTCCGGTCA_4"},{"1":"CTCCTCCAGAAGCTGC_4"},{"1":"CTCTCAGGTTACCCTC_4"},{"1":"CTGTAGAAGTCTCGTA_4"},{"1":"CTGTGAACATTGGGAG_4"},{"1":"GAAATGATCAAAGACA_4"},{"1":"GAAGGACTCACAATGC_4"},{"1":"GAGGGATTCGCGTTTC_4"},{"1":"GAGTTACAGTTCCGTA_4"},{"1":"GATGATCAGGGTAGCT_4"},{"1":"GATTTCTTCCGTGTGG_4"},{"1":"GCAGTTAAGGCATTTC_4"},{"1":"GCATGATTCACGGAGA_4"},{"1":"GCCAGCAAGGGCTGAT_4"},{"1":"GCCATTCCAATGTCAC_4"},{"1":"GGAACCCGTCACCTTC_4"},{"1":"GGATCTATCGAGTTGT_4"},{"1":"GGGTTTAGTAGGTACG_4"},{"1":"GTCTACCCACCTAAAC_4"},{"1":"GTGTTCCCACCTGCGA_4"},{"1":"GTTACAGGTTGCGGAA_4"},{"1":"GTTCTATTCACTCTTA_4"},{"1":"GTTTGGAAGGACAGCT_4"},{"1":"TAACACGAGTGAACAT_4"},{"1":"TACCCACGTGTATCCA_4"},{"1":"TACGTCCGTTATAGAG_4"},{"1":"TAGGTTGCACCCTTGT_4"},{"1":"TATCAGGCAGTTGAAA_4"},{"1":"TCACGGGTCTTTCCAA_4"},{"1":"TCAGCCTGTGTTAGCT_4"},{"1":"TCATATCCATGTCAGT_4"},{"1":"TCCCATGGTGCTTCAA_4"},{"1":"TCGACCTCAAACTAAG_4"},{"1":"TCGACCTCATCGTCCT_4"},{"1":"TCGTCCACAGTGTATC_4"},{"1":"TCTACATTCCGGTAAT_4"},{"1":"TGAACGTCAACCGACC_4"},{"1":"TGACGCGAGAACAGGA_4"},{"1":"TGCACGGTCTACCAGA_4"},{"1":"TGCGACGGTGATTAGA_4"},{"1":"TGGAACTGTTTGACAC_4"},{"1":"TGGTAGTTCGGCTGAC_4"},{"1":"TGTGCGGTCAATCCGA_4"},{"1":"TGTTCATGTTGGGTTT_4"},{"1":"TTCCACGGTCGGTGTC_4"},{"1":"TTCGCTGCACTGCGAC_4"},{"1":"TTCTAACCACTAGGTT_4"},{"1":"TTGAACGCAATAGAGT_4"},{"1":"TTGATGGTCTATCGCC_4"},{"1":"TTGCATTCAGGCACTC_4"},{"1":"TTGGGCGAGCAGGTCA_4"},{"1":"TTGTGGAAGCTCGCAC_4"},{"1":"TTGTTTGAGCATCCCG_4"},{"1":"AAAGGATAGTCATAGA_3"},{"1":"AAATGGAGTAGTTACC_3"},{"1":"AACACACGTCCTCCAT_3"},{"1":"AACCTTTAGTACAGCG_3"},{"1":"AAGACAATCTGAGAAA_3"},{"1":"AAGATAGGTGGTACAG_3"},{"1":"AAGATAGGTGGTCTGC_3"},{"1":"AAGCGAGTCATCTCTA_3"},{"1":"AAGGAATTCACCCTTG_3"},{"1":"AAGTTCGTCTGGTCAA_3"},{"1":"AATTTCCGTACGCGTC_3"},{"1":"ACACTGACAAACCATC_3"},{"1":"ACAGCCGGTACCGTGC_3"},{"1":"ACAGGGAAGGAGAATG_3"},{"1":"ACAGGGACAGCTACCG_3"},{"1":"ACATCGAGTATGTGTC_3"},{"1":"ACCAAACGTTCAAAGA_3"},{"1":"ACCAAACTCTCTTAAC_3"},{"1":"ACCACAAAGGCACGAT_3"},{"1":"ACCACAATCAAATGCC_3"},{"1":"ACCGTTCCAGTTGAAA_3"},{"1":"ACCTACCGTTCGATTG_3"},{"1":"ACGCACGAGGATTCAA_3"},{"1":"ACGGAAGTCTAGCCAA_3"},{"1":"ACGGGTCGTTACGGAG_3"},{"1":"ACGGTCGAGACTTCGT_3"},{"1":"ACGTCCTCAACTGCCG_3"},{"1":"ACGTTCCCAAATTGCC_3"},{"1":"ACTATTCAGAGCAGTC_3"},{"1":"ACTGATGTCCGTATGA_3"},{"1":"ACTTCCGCACATGTTG_3"},{"1":"ACTTTCAAGTTACGAA_3"},{"1":"AGACAAAGTTCTCTCG_3"},{"1":"AGACACTTCGTGCTCT_3"},{"1":"AGAGAATAGCTTAAGA_3"},{"1":"AGATCCAAGGACATCG_3"},{"1":"AGCGCTGCAACTGATC_3"},{"1":"AGCTCAAGTTGGGCCT_3"},{"1":"AGGAGGTCACGACAGA_3"},{"1":"AGGCATTCACAAGCCC_3"},{"1":"AGGCATTGTGACAGCA_3"},{"1":"AGGCCACTCAAAGACA_3"},{"1":"AGGCCACTCAGAACCT_3"},{"1":"AGGGCTCTCCCGTGTT_3"},{"1":"AGGGTTTTCTTACGTT_3"},{"1":"AGGTGTTCATGGAGAC_3"},{"1":"AGTAACCTCGGTATGT_3"},{"1":"AGTCACATCGAGTGGA_3"},{"1":"AGTCTCCCAAGGACAC_3"},{"1":"AGTTCCCGTAACAGTA_3"},{"1":"ATACCTTAGTATCCTG_3"},{"1":"ATACCTTCAGGCCCTA_3"},{"1":"ATACCTTTCGGCTGAC_3"},{"1":"ATAGGCTTCCTGATAG_3"},{"1":"ATAGGCTTCGTTCTAT_3"},{"1":"ATCACAGCATTCAGCA_3"},{"1":"ATCACGACAGCTTTGA_3"},{"1":"ATCCTATAGCAATTAG_3"},{"1":"ATCCTATTCTCCGAAA_3"},{"1":"ATCGGCGTCCGTCACT_3"},{"1":"ATCGGCGTCTCATAGG_3"},{"1":"ATCGTGAAGCGTCAGA_3"},{"1":"ATCTCTATCTAGCATG_3"},{"1":"ATCTTCAAGTTTGCTG_3"},{"1":"ATGAAAGCATCATGAC_3"},{"1":"ATGCATGGTGTGGTCC_3"},{"1":"ATGGGAGAGTGCAGGT_3"},{"1":"ATGGGAGCATGAGTAA_3"},{"1":"ATGGTTGAGAAACTAC_3"},{"1":"ATTCAGGGTGGAGGTT_3"},{"1":"ATTCATCTCCGCACGA_3"},{"1":"ATTCTTGCAGGTCAAG_3"},{"1":"ATTGGGTCATACTTTC_3"},{"1":"CAAAGAAAGGAAGTAG_3"},{"1":"CAACAACGTCTTGCGG_3"},{"1":"CAACCAATCCATTGTT_3"},{"1":"CAACGATCACCGTCTT_3"},{"1":"CAAGAGGCATGCGTGC_3"},{"1":"CAAGCTAAGCTGTCCG_3"},{"1":"CAATGACAGGCGAACT_3"},{"1":"CAATTTCAGAGAACCC_3"},{"1":"CACAGATGTCAGGTGA_3"},{"1":"CACCGTTGTACTCGTA_3"},{"1":"CACTGTCCAATGAAAC_3"},{"1":"CAGAGCCTCTAGCATG_3"},{"1":"CAGATACTCAGTGATC_3"},{"1":"CAGCAATCAAGTGATA_3"},{"1":"CAGCCAGAGCAGTACG_3"},{"1":"CAGCGTGCAACTTGCA_3"},{"1":"CAGCGTGCATACCAGT_3"},{"1":"CAGGCCAAGGGTACAC_3"},{"1":"CAGGCCATCGGTAAGG_3"},{"1":"CAGGTATCAGCAGGAT_3"},{"1":"CAGGTATGTTGGACTT_3"},{"1":"CAGTTAGAGCAGCAGT_3"},{"1":"CATACTTTCCATCGTC_3"},{"1":"CATCGCTGTTGGGATG_3"},{"1":"CATCGTCAGGAACTAT_3"},{"1":"CATGCAACAGACGATG_3"},{"1":"CATGGTAGTGTGCCTG_3"},{"1":"CATTGCCCAGTGAGCA_3"},{"1":"CCAAGCGTCCGAGATT_3"},{"1":"CCAATGACAGTCGGTC_3"},{"1":"CCAATGACATCTCATT_3"},{"1":"CCAATTTGTGATACAA_3"},{"1":"CCACCATCATATACCG_3"},{"1":"CCATAAGAGATGTTCC_3"},{"1":"CCCAACTAGTTCGGTT_3"},{"1":"CCCGAAGAGATGCAGC_3"},{"1":"CCCGAAGTCTGGTGCG_3"},{"1":"CCCGGAATCCAGTTCC_3"},{"1":"CCGATCTGTACACTCA_3"},{"1":"CCGGACACAAGGCAAC_3"},{"1":"CCGGACACATACAGAA_3"},{"1":"CCGTAGGAGCACCAGA_3"},{"1":"CCGTAGGCAAGAAACT_3"},{"1":"CCTAAGAGTGGCTCTG_3"},{"1":"CCTAAGATCTCGGTCT_3"},{"1":"CCTCAGTCAAATGAAC_3"},{"1":"CCTCAGTGTATTGGCT_3"},{"1":"CCTCATGAGGCCTTCG_3"},{"1":"CCTCTAGAGTGCTCAT_3"},{"1":"CCTTCAGAGAGCCTGA_3"},{"1":"CGAGAAGGTATCGTTG_3"},{"1":"CGAGAAGTCAAAGGAT_3"},{"1":"CGAGTGCAGTGCCGAA_3"},{"1":"CGAGTTATCTTCCGTG_3"},{"1":"CGATGCGTCCCGTTGT_3"},{"1":"CGATGCGTCTCCGCAT_3"},{"1":"CGCGTGACAATCAGCT_3"},{"1":"CGGAATTCACCAGCTG_3"},{"1":"CGTAATGAGCCATTGT_3"},{"1":"CGTGATATCTAGCATG_3"},{"1":"CGTTAGATCACTGTTT_3"},{"1":"CGTTCTGCAGCATGCC_3"},{"1":"CTAACTTAGCAGGTCA_3"},{"1":"CTACCTGAGCCATTCA_3"},{"1":"CTACGGGGTTGATGTC_3"},{"1":"CTATAGGAGGCGTCCT_3"},{"1":"CTCAGGGTCTTCTCAA_3"},{"1":"CTCAGTCAGGAACTCG_3"},{"1":"CTCAGTCTCCGCGAGT_3"},{"1":"CTCCCAACAAATCGTC_3"},{"1":"CTCCGATTCCCATGGG_3"},{"1":"CTCGAGGTCTTTGCTA_3"},{"1":"CTCTCAGAGCCAAGTG_3"},{"1":"CTGCATCTCGTCCTTG_3"},{"1":"CTGCGAGGTTGAAGTA_3"},{"1":"CTGGTCTGTGGGCTTC_3"},{"1":"CTGTAGAGTCTTTCTA_3"},{"1":"CTGTATTCATGATAGA_3"},{"1":"CTTAGGAGTGACCGTC_3"},{"1":"CTTCCTTAGAGCTGAC_3"},{"1":"CTTCCTTGTTATGTCG_3"},{"1":"CTTGAGACAATTAGGA_3"},{"1":"CTTTCGGTCGAGATGG_3"},{"1":"GAAGAATCATGTTACG_3"},{"1":"GAAGTAAAGTGAGTTA_3"},{"1":"GAATAGAAGAAACTCA_3"},{"1":"GACACGCGTGATAGTA_3"},{"1":"GACAGCCGTCGTTCAA_3"},{"1":"GACATCAGTTCCGCTT_3"},{"1":"GACTCAAGTAGTGGCA_3"},{"1":"GAGAAATGTTGGGTAG_3"},{"1":"GAGACCCAGAGCCTGA_3"},{"1":"GAGCCTGTCGAACTCA_3"},{"1":"GAGTGAGAGTGGTTCT_3"},{"1":"GAGTGAGCAAAGGATT_3"},{"1":"GAGTTGTGTAGTCACT_3"},{"1":"GATCGTAAGGTCATTC_3"},{"1":"GATCGTAGTCATGCAT_3"},{"1":"GATGAGGCATGCCGAC_3"},{"1":"GATGGAGCATATCTGG_3"},{"1":"GCACGGTTCACGGTCG_3"},{"1":"GCACGTGCAGTGTACT_3"},{"1":"GCAGCCAAGCTGTTCA_3"},{"1":"GCATCTCGTCGAGTGA_3"},{"1":"GCCAGCACAGGTGTGA_3"},{"1":"GCCAGTGTCAGTCATG_3"},{"1":"GCCATGGGTAACAGTA_3"},{"1":"GCCATTCGTAATTAGG_3"},{"1":"GCCGATGTCTTCACAT_3"},{"1":"GCCGATGTCTTGAACG_3"},{"1":"GCCTGTTAGAGAGCCT_3"},{"1":"GCGGAAACACAGCGCT_3"},{"1":"GCGGATCGTTGTCATG_3"},{"1":"GCGTTTCAGTTCATCG_3"},{"1":"GCGTTTCTCCGTGCGA_3"},{"1":"GGACGTCTCCACGGAC_3"},{"1":"GGAGATGAGGATCATA_3"},{"1":"GGAGGATAGCGTGTTT_3"},{"1":"GGAGGATCATGGAGAC_3"},{"1":"GGATGTTAGCGTCTCG_3"},{"1":"GGCTTGGGTAGTATAG_3"},{"1":"GGGATGAAGGCGTCCT_3"},{"1":"GGGTAGACAGCCCACA_3"},{"1":"GGGTCACGTACTGGGA_3"},{"1":"GGGTCACTCTAAGGAA_3"},{"1":"GGGTCTGCAGACGATG_3"},{"1":"GGGTGAAAGGCCATAG_3"},{"1":"GGGTGAATCGCTGACG_3"},{"1":"GGTAATCCATTCGGGC_3"},{"1":"GGTAGAGTCAAACCCA_3"},{"1":"GGTGAAGTCTCCGATC_3"},{"1":"GGTGATTTCTAACGCA_3"},{"1":"GGTTAACAGTGGTTGG_3"},{"1":"GGTTCTCGTTACGATC_3"},{"1":"GGTTCTCTCGCTTGAA_3"},{"1":"GGTTGTAGTGCGGATA_3"},{"1":"GTAACACTCCTTGAAG_3"},{"1":"GTAGAAACAAACCGGA_3"},{"1":"GTAGATCAGAGTCAGC_3"},{"1":"GTAGGAGAGGTCCAGA_3"},{"1":"GTAGTACAGTACCATC_3"},{"1":"GTAGTACCACGGCTAC_3"},{"1":"GTCAAACCACTGTTCC_3"},{"1":"GTCAAACGTATTGAGA_3"},{"1":"GTCACTCCATTACGGT_3"},{"1":"GTCCCATAGTGTTCAC_3"},{"1":"GTCCCATCACCATAAC_3"},{"1":"GTGACGCCATGTTCGA_3"},{"1":"GTGACGCTCTCAGGCG_3"},{"1":"GTGAGGACATTCATCT_3"},{"1":"GTGAGTTTCGACGACC_3"},{"1":"GTGGAAGCATATGAAG_3"},{"1":"GTGGTTAAGTGCCGAA_3"},{"1":"GTGGTTATCACCTTAT_3"},{"1":"GTGTCCTCACATCCCT_3"},{"1":"GTGTGGCAGCCATTTG_3"},{"1":"GTGTTAGCAACCAACT_3"},{"1":"GTTCTATTCCTCTAAT_3"},{"1":"GTTGCGGTCATTTGGG_3"},{"1":"GTTGTAGCACTATGTG_3"},{"1":"TAACCAGAGTCCGCCA_3"},{"1":"TAAGTCGAGAGTCAAT_3"},{"1":"TAATTCCTCACGATCA_3"},{"1":"TACACCCTCACCGGTG_3"},{"1":"TACCCACGTCTGTCCT_3"},{"1":"TACCGAACATGGGCAA_3"},{"1":"TACCGGGCAGGCGAAT_3"},{"1":"TACTTCACAGTAGAAT_3"},{"1":"TAGAGTCAGCTGGTGA_3"},{"1":"TAGATCGGTTACGCCG_3"},{"1":"TAGCACAAGAGCAACC_3"},{"1":"TAGGGTTCATGACAAA_3"},{"1":"TAGGTTGAGAACAAGG_3"},{"1":"TATCAGGAGCGACTTT_3"},{"1":"TATCTGTGTGTCCACG_3"},{"1":"TATTGCTAGGTCGAGT_3"},{"1":"TCAAGTGAGACTGAGC_3"},{"1":"TCAAGTGTCCACACAA_3"},{"1":"TCACACCAGGTCGCCT_3"},{"1":"TCACGGGGTACTCGTA_3"},{"1":"TCACTATGTCAGTTTG_3"},{"1":"TCACTCGAGGTTGAGC_3"},{"1":"TCAGCCTAGAACTGAT_3"},{"1":"TCAGTCCGTAGTCGTT_3"},{"1":"TCAGTTTGTAGATCGG_3"},{"1":"TCAGTTTTCCACGTGG_3"},{"1":"TCATACTAGACTCTAC_3"},{"1":"TCATATCCACCAGTAT_3"},{"1":"TCATGCCAGATGTTGA_3"},{"1":"TCATGCCAGTGCGACA_3"},{"1":"TCATTACTCCGAAATC_3"},{"1":"TCATTCAGTCGCACAC_3"},{"1":"TCATTGTCAGTGTACT_3"},{"1":"TCCACGTAGGGCAGTT_3"},{"1":"TCCGAAAAGCCAGTAG_3"},{"1":"TCCGTGTCAAACACGG_3"},{"1":"TCCGTGTCATGAGTAA_3"},{"1":"TCCTAATGTTAAGACA_3"},{"1":"TCCTGCAGTGTACATC_3"},{"1":"TCGCAGGGTCATCGCG_3"},{"1":"TCGCAGGTCCCGGTAG_3"},{"1":"TCGCTTGGTATCGATC_3"},{"1":"TCGGGTGCAATTAGGA_3"},{"1":"TCTAACTGTCTATGAC_3"},{"1":"TCTATACCAACTGCCG_3"},{"1":"TCTCACGGTAGCTGTT_3"},{"1":"TCTTTGACACAAGCAG_3"},{"1":"TGAACGTTCGCAGTGC_3"},{"1":"TGACAGTCACGAGAAC_3"},{"1":"TGACGCGTCTCAACGA_3"},{"1":"TGAGACTGTCTAGGCC_3"},{"1":"TGAGCATAGACTCATC_3"},{"1":"TGAGCATAGCCTTTCC_3"},{"1":"TGAGGTTGTCAACACT_3"},{"1":"TGAGTCAAGACACACG_3"},{"1":"TGATGCAGTCTTGCGG_3"},{"1":"TGATTCTAGCTGTTCA_3"},{"1":"TGATTCTCATTATGCG_3"},{"1":"TGATTCTTCAGTCATG_3"},{"1":"TGCCGAGGTCTTGAGT_3"},{"1":"TGCGATATCCGAGCTG_3"},{"1":"TGCTTGCAGAGCTTTC_3"},{"1":"TGGATCAAGGTTAGTA_3"},{"1":"TGGATCATCTGTAAGC_3"},{"1":"TGGATGTTCGCGATCG_3"},{"1":"TGGGAGACACTTGTCC_3"},{"1":"TGGGCGTTCCTCACCA_3"},{"1":"TGGTGATTCGGTAGGA_3"},{"1":"TGTACAGAGAATTTGG_3"},{"1":"TGTACAGAGGTCGACA_3"},{"1":"TGTAGACCAAAGTGTA_3"},{"1":"TGTCCCATCTGCGAGC_3"},{"1":"TGTTCCGGTCGAGTTT_3"},{"1":"TGTTCCGGTTAGTCGT_3"},{"1":"TGTTCTAGTATGAAAC_3"},{"1":"TTACCATGTAACGCGA_3"},{"1":"TTAGGCAAGCTGGCCT_3"},{"1":"TTAGGCAAGTAATCCC_3"},{"1":"TTATTGCAGAGTGTTA_3"},{"1":"TTCCAATGTAGAGATT_3"},{"1":"TTCCGTGCAGGCAATG_3"},{"1":"TTGACCCTCGTGGGTC_3"},{"1":"TTGCATTTCGCGTCGA_3"},{"1":"TTGCGTCTCGCCGAGT_3"},{"1":"TTGGGATCACCGCTGA_3"},{"1":"TTGGGTAGTTGGATCT_3"},{"1":"TTTACTGAGCCAGACA_3"},{"1":"TTTACTGTCCCAGGAC_3"},{"1":"TTTGATCAGAATCCCT_3"},{"1":"AAAGGGCGTTTCAGAC_4"},{"1":"AACCTGATCCACAAGT_4"},{"1":"ACAGAAAAGTGGACTG_4"},{"1":"ACAGCCGGTTGAAGTA_4"},{"1":"ACGGTTATCGGCTGTG_4"},{"1":"AGAAGCGCATTACTCT_4"},{"1":"AGATCGTGTATCGTTG_4"},{"1":"AGATGAAAGCAACCAG_4"},{"1":"AGGAAATCATAATGCC_4"},{"1":"AGGCATTGTGCCGTTG_4"},{"1":"ATCAGGTAGATGTTGA_4"},{"1":"ATCGTAGAGAAACTCA_4"},{"1":"ATGAAAGTCTTCACAT_4"},{"1":"ATGGGTTGTCCGCAGT_4"},{"1":"ATTACCTTCGCCCAGA_4"},{"1":"ATTCAGGTCTCCCAAC_4"},{"1":"ATTCGTTCATCAGCGC_4"},{"1":"CAAGCTATCTGCCTCA_4"},{"1":"CAATCGATCCGAAATC_4"},{"1":"CACTGGGGTTCAGGTT_4"},{"1":"CATGGATGTGCCCGTA_4"},{"1":"CATGGTATCCCGAATA_4"},{"1":"CATTCTATCGGATACT_4"},{"1":"CCCATTGTCGTGCAGC_4"},{"1":"CCCGGAACAATGAACA_4"},{"1":"CGGAGAATCTCGAACA_4"},{"1":"CGTCAAACACCAGGTC_4"},{"1":"CTATAGGAGCTAGAGC_4"},{"1":"CTCAGTCCATAGGTTC_4"},{"1":"CTGCCTACACTACTTT_4"},{"1":"CTGGTCTCACCTCGTT_4"},{"1":"CTGTCGTAGTTTCAGC_4"},{"1":"GACTTCCTCAAGGAGC_4"},{"1":"GAGGCAATCTACACAG_4"},{"1":"GAGTGAGAGAATCTAG_4"},{"1":"GAGTGTTAGTAACGAT_4"},{"1":"GCGGAAAGTCCGGATC_4"},{"1":"GCTGCAGTCGTTCTAT_4"},{"1":"GGATCTAAGGTCGCCT_4"},{"1":"GGCACGTAGAAGTGTT_4"},{"1":"GGTGGCTCAGACTCTA_4"},{"1":"GTAACCATCGGCACTG_4"},{"1":"GTCACTCCAGACAAGC_4"},{"1":"GTTACAGGTCCGGTGT_4"},{"1":"GTTCATTAGCTCTGTA_4"},{"1":"GTTGTAGTCTTGATTC_4"},{"1":"TACAACGTCTAGAGCT_4"},{"1":"TACGGTAAGAGGATGA_4"},{"1":"TAGGGTTGTCACTTAG_4"},{"1":"TATCGCCGTGGAATGC_4"},{"1":"TCATATCTCTGCTGAA_4"},{"1":"TCCGTGTGTAGTTCCA_4"},{"1":"TCGAAGTAGTGCAGGT_4"},{"1":"TCGGATAAGCGATTCT_4"},{"1":"TCGTGGGAGGCACTAG_4"},{"1":"TCTATCAGTCTACAGT_4"},{"1":"TCTCAGCGTAATGTGA_4"},{"1":"TCTGGCTCACACGCCA_4"},{"1":"TCTTCCTTCGAGAGCA_4"},{"1":"TGAATCGAGGCCTAGA_4"},{"1":"TGACAGTTCCAGGACC_4"},{"1":"TGAGCATGTTTCGATG_4"},{"1":"TGCTTCGCAAATACGA_4"},{"1":"TGGTTAGCACGGGCTT_4"},{"1":"TGTAAGCCAAGGAGTC_4"},{"1":"TGTCCCAAGGATCATA_4"},{"1":"TGTTCATGTATCGAAA_4"},{"1":"TGTTCTAAGCCTCTGG_4"},{"1":"TGTTCTATCAAGGACG_4"},{"1":"TGTTGAGCAAGGTTGG_4"},{"1":"TTAGGCATCCTACCAC_4"},{"1":"TTCTTCCGTTGGTACT_4"},{"1":"TTTACTGGTTCTCGTC_4"},{"1":"TTTCAGTCACCATTCC_4"},{"1":"TTTGATCTCAGCACCG_4"},{"1":"AAAGAACGTTGGGCCT_3"},{"1":"AAAGGGCCAGTTGGTT_3"},{"1":"AACCTTTGTCCTGTTC_3"},{"1":"AACCTTTTCGTGAGAG_3"},{"1":"AAGATAGCACAAATAG_3"},{"1":"AAGCGAGAGGGTGAAA_3"},{"1":"AATGGCTTCGCTCTAC_3"},{"1":"ACACGCGAGCACTCGC_3"},{"1":"ACTTTGTAGCTTAGTC_3"},{"1":"AGATGCTAGTCTCGTA_3"},{"1":"AGCCACGCATCGTGGC_3"},{"1":"AGGATAACACGCGTGT_3"},{"1":"AGGGAGTGTGATAGAT_3"},{"1":"AGGGTCCGTCAAATCC_3"},{"1":"AGTCAACGTATGCGTT_3"},{"1":"AGTTAGCGTCCCTGAG_3"},{"1":"ATAGACCGTGGCACTC_3"},{"1":"ATCGGCGCAAGAATAC_3"},{"1":"ATGCGATCAAAGGGCT_3"},{"1":"ATGCGATTCCAAATGC_3"},{"1":"ATTCTTGGTGTGGACA_3"},{"1":"CAAGAGGGTCTGCAAT_3"},{"1":"CACATGATCGAGTGAG_3"},{"1":"CACGTTCCACGGTGAA_3"},{"1":"CAGCGTGCAGTCGGTC_3"},{"1":"CATAAGCCAAGGACAC_3"},{"1":"CATAAGCTCGTAATGC_3"},{"1":"CATTCATAGCCTTTGA_3"},{"1":"CATTGAGAGGGTATAT_3"},{"1":"CCTACGTAGCATTGAA_3"},{"1":"CCTCATGAGCGTTGTT_3"},{"1":"CGGGACTTCCGATCTC_3"},{"1":"CGTAAGTAGGTACAAT_3"},{"1":"CGTGATACACCGTGAC_3"},{"1":"CTCATGCTCGCACGGT_3"},{"1":"CTCGAGGAGTTTGGCT_3"},{"1":"CTGCGAGAGCTGCGAA_3"},{"1":"CTGGACGCAGTAGAGC_3"},{"1":"CTTCGGTTCGTGTTCC_3"},{"1":"GAACACTGTCTAGATC_3"},{"1":"GAAGGACGTGGCTTAT_3"},{"1":"GAGGCCTTCGGTAGGA_3"},{"1":"GATCCCTCAGCGGTCT_3"},{"1":"GCCATTCTCCACTGAA_3"},{"1":"GCGTTTCGTGACGTCC_3"},{"1":"GCTGAATTCCGAACGC_3"},{"1":"GGAGATGCAACAACAA_3"},{"1":"GGAGGTAGTTACCCAA_3"},{"1":"GGATGTTTCATAAGGA_3"},{"1":"GGGCGTTCATGACGTT_3"},{"1":"GGTGAAGTCACGAGGA_3"},{"1":"GTAGGAGAGGGCGAGA_3"},{"1":"GTCGCGAAGAAGGTAG_3"},{"1":"GTTACGAAGGTGGCTA_3"},{"1":"GTTCATTGTGAGTTGG_3"},{"1":"GTTGCGGAGGCCACCT_3"},{"1":"TACACCCCATGACAGG_3"},{"1":"TACATTCGTACCACGC_3"},{"1":"TACCCGTGTAATGCGG_3"},{"1":"TACCGAATCTCCGCAT_3"},{"1":"TAGAGTCTCACTTGGA_3"},{"1":"TAGGGTTAGACCCTTA_3"},{"1":"TATCTGTGTACGATGG_3"},{"1":"TATCTTGAGTGGCCTC_3"},{"1":"TCAATTCAGCTAGAAT_3"},{"1":"TCACAAGCAATTGCGT_3"},{"1":"TCACTCGAGAGCAGCT_3"},{"1":"TCAGCCTAGGTATTGA_3"},{"1":"TCATTCAGTGAGGCAT_3"},{"1":"TCCATGCAGGGAGGCA_3"},{"1":"TCCGAAATCTCCTGCA_3"},{"1":"TCGAAGTAGCCTAGGA_3"},{"1":"TCGCACTTCGTTGTAG_3"},{"1":"TCGTGCTAGTCAGAGC_3"},{"1":"TCGTGGGAGGAAGTGA_3"},{"1":"TGAGCATTCCCTCATG_3"},{"1":"TGAGGTTCACCCGTAG_3"},{"1":"TGAGTCACAAAGCGTG_3"},{"1":"TGATGCACACGTAACT_3"},{"1":"TGCAGATAGAGGGTGG_3"},{"1":"TGCGGCAGTTGTTTGG_3"},{"1":"TGGGAGAGTTGTCTAG_3"},{"1":"TGGGCGTAGAGTATAC_3"},{"1":"TGGGCTGCATTCAGCA_3"},{"1":"TGGTACACACCTCAGG_3"},{"1":"TGGTTAGCATCGGAAG_3"},{"1":"TGTCCTGAGATCCGAG_3"},{"1":"TTACGTTAGGACACTG_3"},{"1":"TTATTGCAGAAGTCAT_3"},{"1":"TTCAATCGTAAGCTCT_3"},{"1":"TTGTGGATCCGGACTG_3"},{"1":"TTGTTTGGTCACCTTC_3"},{"1":"TTTAGTCAGTGCACAG_3"},{"1":"TTTGGTTTCTCTAGGA_3"},{"1":"AACCCAACACTGCTTC_4"},{"1":"AAGAACAGTAGATTGA_4"},{"1":"ACATCCCAGAGTCTTC_4"},{"1":"ACGATCACATCCGTGG_4"},{"1":"ACGTTCCGTGGACCTC_4"},{"1":"AGACAAATCGGAGTAG_4"},{"1":"AGAGAGCGTGCCTGCA_4"},{"1":"AGCGTCGCATTCTGTT_4"},{"1":"AGGTCTACACTAACCA_4"},{"1":"ATACCGAAGACGGAAA_4"},{"1":"ATCACTTCAAGCGCTC_4"},{"1":"CAACGGCGTATCGAGG_4"},{"1":"CCACGAGAGGGTAATT_4"},{"1":"CCGAACGTCATCGGGC_4"},{"1":"CGATGCGAGTACGTCT_4"},{"1":"CGCATGGAGAGTCAAT_4"},{"1":"CTCATTACAATCAGCT_4"},{"1":"CTCTGGTGTCGTATTG_4"},{"1":"CTGAGGCTCAAGCCCG_4"},{"1":"CTGTGAAAGGTTCCGC_4"},{"1":"GAAGAATTCTTTGGAG_4"},{"1":"GACCAATGTTCTCACC_4"},{"1":"GAGTTGTGTAGGACTG_4"},{"1":"GCCCGAAGTGTACATC_4"},{"1":"GTGGAAGAGCTAGATA_4"},{"1":"GTGGTTATCCACGGAC_4"},{"1":"GTTTGGATCGATGGAG_4"},{"1":"TAATTCCAGGCCTTGC_4"},{"1":"TCAAGCACAATGAAAC_4"},{"1":"TCCATCGAGGACTGGT_4"},{"1":"TCGACGGGTAACATGA_4"},{"1":"TGAGGAGTCGTTATCT_4"},{"1":"TGCCGAGAGTGGTCAG_4"},{"1":"TGGCGTGCACTGCACG_4"},{"1":"TGGTACACAACTCGTA_4"},{"1":"TGTGAGTAGCTTAAGA_4"},{"1":"TGTTCATCACTGTCGG_4"},{"1":"TTTGTTGGTTAAACAG_4"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<div id="healthy-diseased" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Healthy-Diseased</h1>
<ul>
<li>Healthy samples:
<ul>
<li>Dataset 1.1 “Breast” sample IDs: s1, s2, s3</li>
<li>Dataset 2 “Vascular” sample IDs: EC_1, EC_2, EC_3, EC_4</li>
<li>Dataset 3 “Aging” sample IDs: S1, S2, S3, S4, S5</li>
<li>Dataset 6.1 “Psoriasis” sample IDs: Ctrl1, Ctrl2, Ctrl3</li>
<li>Dataset 7.1 “Dermatitis” sample IDs: 4, 6, 8, 9, 10, 12, 13, 17</li>
</ul></li>
<li>Diseased samples:
<ul>
<li>Dataset 1.2 “Breast” sample IDs: E1, E2, E3, E4, P1, P2, P3</li>
<li>Dataset 6.2 “Psoriasis” sample IDs: Psor1, Psor2, Psor3</li>
<li>Dataset 7.2 “Dermatitis” sample IDs: 1, 2, 5, 7</li>
</ul></li>
</ul>
<div id="merging" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Merging</h2>
<p>Individual datasets are merged into a single Seurat object.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>breast_h <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy/unintegrated/breast.Rds&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>bh <span class="ot">&lt;-</span> breast_h[[]]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(bh) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">colnames</span>(bh)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>],<span class="fu">tolower</span>(<span class="fu">colnames</span>(bh)[<span class="dv">4</span><span class="sc">:</span><span class="dv">8</span>]))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>bh<span class="sc">$</span>rna_snn_res.<span class="fl">0.2</span> <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>bh<span class="sc">$</span>seurat_clusters <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>bh<span class="sc">$</span>tissue <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">recode</span>(bh<span class="sc">$</span>skin_type,<span class="st">`</span><span class="at">Epi</span><span class="st">`</span><span class="ot">=</span><span class="st">&quot;Epidermis&quot;</span>,<span class="st">`</span><span class="at">Derm</span><span class="st">`</span><span class="ot">=</span><span class="st">&quot;Dermis&quot;</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>bh<span class="sc">$</span>skin_type <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>bh<span class="sc">$</span>condition <span class="ot">&lt;-</span> <span class="st">&quot;healthy&quot;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>bh<span class="sc">$</span>sample <span class="ot">&lt;-</span> bh<span class="sc">$</span>orig.ident</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>ad <span class="ot">&lt;-</span> <span class="fu">GetAssayData</span>(breast_h,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;counts&quot;</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ad) <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(<span class="fu">rownames</span>(ad))</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>breast_h1 <span class="ot">&lt;-</span> <span class="fu">CreateSeuratObject</span>(<span class="at">counts=</span>ad,<span class="at">meta.data=</span>bh)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>breast_d <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/breast.Rds&quot;</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>bd <span class="ot">&lt;-</span> breast_d[[]]</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(bd) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">colnames</span>(bd)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>],<span class="fu">tolower</span>(<span class="fu">colnames</span>(bd)[<span class="dv">4</span><span class="sc">:</span><span class="dv">24</span>]))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>bd<span class="sc">$</span>rna_snn_res.<span class="fl">0.2</span> <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>bd<span class="sc">$</span>seurat_clusters <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>bd<span class="sc">$</span>mad_prd <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>bd<span class="sc">$</span>location <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>bd<span class="sc">$</span>stage <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>bd<span class="sc">$</span>individual <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>bd<span class="sc">$</span>orig.ident <span class="ot">&lt;-</span> bd<span class="sc">$</span>sample</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>bd<span class="sc">$</span>status <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">as.character</span>(bd<span class="sc">$</span>status))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>ad <span class="ot">&lt;-</span> <span class="fu">GetAssayData</span>(breast_d,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;counts&quot;</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ad) <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(<span class="fu">rownames</span>(ad))</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>breast_d1 <span class="ot">&lt;-</span> <span class="fu">CreateSeuratObject</span>(<span class="at">counts=</span>ad,<span class="at">meta.data=</span>bd)</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>psoriasis <span class="ot">&lt;-</span> <span class="fu">merge</span>(<span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy/unintegrated/psoriasis.Rds&quot;</span>),</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/psoriasis.Rds&quot;</span>))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>psoriasis<span class="sc">$</span>RNA_snn_res.<span class="fl">0.2</span> <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>psoriasis<span class="sc">$</span>seurat_clusters <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>psoriasis<span class="sc">$</span>orig.ident <span class="ot">&lt;-</span> <span class="fu">as.character</span>(psoriasis<span class="sc">$</span>orig.ident)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>psoriasis<span class="sc">$</span>sample <span class="ot">&lt;-</span> psoriasis<span class="sc">$</span>orig.ident</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>psoriasis<span class="sc">$</span>condition <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(psoriasis<span class="sc">$</span>condition),<span class="st">&quot;healthy&quot;</span>,psoriasis<span class="sc">$</span>condition)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>ad <span class="ot">&lt;-</span> <span class="fu">GetAssayData</span>(psoriasis,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;counts&quot;</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ad) <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(<span class="fu">rownames</span>(ad))</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>psoriasis <span class="ot">&lt;-</span> <span class="fu">CreateSeuratObject</span>(<span class="at">counts=</span>ad,<span class="at">meta.data=</span>psoriasis[[]])</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dermatitis <span class="ot">&lt;-</span> <span class="fu">merge</span>(<span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy/unintegrated/dermatitis.Rds&quot;</span>),</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/dermatitis.Rds&quot;</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>dermatitis<span class="sc">$</span>RNA_snn_res.<span class="fl">0.2</span> <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>dermatitis<span class="sc">$</span>seurat_clusters <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>dermatitis<span class="sc">$</span>orig.ident <span class="ot">&lt;-</span> <span class="fu">as.character</span>(dermatitis<span class="sc">$</span>orig.ident)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>dermatitis<span class="sc">$</span>sample <span class="ot">&lt;-</span> dermatitis<span class="sc">$</span>orig.ident</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>dermatitis<span class="sc">$</span>condition <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(dermatitis<span class="sc">$</span>condition),<span class="st">&quot;healthy&quot;</span>,dermatitis<span class="sc">$</span>condition)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>ad <span class="ot">&lt;-</span> <span class="fu">GetAssayData</span>(dermatitis,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;counts&quot;</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ad) <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(<span class="fu">rownames</span>(ad))</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>dermatitis <span class="ot">&lt;-</span> <span class="fu">CreateSeuratObject</span>(<span class="at">counts=</span>ad,<span class="at">meta.data=</span>dermatitis[[]])</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>vascular <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy/unintegrated/vascular.Rds&quot;</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>vascular<span class="sc">$</span>seurat_clusters <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>vascular<span class="sc">$</span>condition <span class="ot">&lt;-</span> <span class="st">&quot;healthy&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>vascular<span class="sc">$</span>sample <span class="ot">&lt;-</span> vascular<span class="sc">$</span>orig.ident</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>aging <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy/unintegrated/aging.Rds&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>aging<span class="sc">$</span>seurat_clusters <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>aging<span class="sc">$</span>condition <span class="ot">&lt;-</span> <span class="st">&quot;healthy&quot;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>aging<span class="sc">$</span>sample <span class="ot">&lt;-</span> aging<span class="sc">$</span>orig.ident</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>aging<span class="sc">$</span>age_class <span class="ot">&lt;-</span> aging<span class="sc">$</span>age</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>aging<span class="sc">$</span>age <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>ad <span class="ot">&lt;-</span> <span class="fu">GetAssayData</span>(aging,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;counts&quot;</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(ad) <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(<span class="fu">rownames</span>(ad))</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>aging <span class="ot">&lt;-</span> <span class="fu">CreateSeuratObject</span>(<span class="at">counts=</span>ad,<span class="at">meta.data=</span>aging[[]])</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">merge</span>(<span class="fu">merge</span>(<span class="fu">merge</span>(<span class="fu">merge</span>(<span class="fu">merge</span>(breast_h1,breast_d1),psoriasis),dermatitis),aging),vascular)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(<span class="fu">factor</span>(s<span class="sc">$</span>orig.ident))))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">PercentageFeatureSet</span>(s, <span class="st">&quot;^Mt-&quot;</span>, <span class="at">col.name =</span> <span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">PercentageFeatureSet</span>(s, <span class="st">&quot;^Rpl.?&quot;</span>, <span class="at">col.name =</span> <span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition,s<span class="sc">$</span>study,s<span class="sc">$</span>orig.ident,s<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<p>Overview of full dataset.</p>
<pre><code>41406 features across 87319 samples within 1 assay

   condition      study   ind sample cells
1   diseased     breast    E1     16  3542
2   diseased     breast    E2     17  3650
3   diseased     breast    E3     18  1666
4   diseased     breast    E4     19  3401
5   diseased     breast    P1     24  3996
6   diseased     breast    P2     25  4509
7   diseased     breast    P3     26  4785
8   diseased dermatitis     1     01   539
9   diseased dermatitis     2     06   542
10  diseased dermatitis     5     08   697
11  diseased dermatitis     7     10   523
12  diseased  psoriasis Psor1     27   824
13  diseased  psoriasis Psor2     28   488
14  diseased  psoriasis Psor3     29   804
15   healthy      aging    S1     31   183
16   healthy      aging    S2     33   319
17   healthy      aging    S3     35   611
18   healthy      aging    S4     36   246
19   healthy      aging    S5     37   402
20   healthy     breast    s1     30  6816
21   healthy     breast    s2     32  4551
22   healthy     breast    s3     34  2573
23   healthy dermatitis    10     02   440
24   healthy dermatitis    12     03  1205
25   healthy dermatitis    13     04   169
26   healthy dermatitis    17     05   478
27   healthy dermatitis     4     07  1150
28   healthy dermatitis     6     09  1562
29   healthy dermatitis     8     11    71
30   healthy dermatitis     9     12  1788
31   healthy  psoriasis Ctrl1     13   314
32   healthy  psoriasis Ctrl2     14   344
33   healthy  psoriasis Ctrl3     15   866
34   healthy   vascular  EC_1     20  1267
35   healthy   vascular  EC_2     21   571
36   healthy   vascular  EC_3     22 16645
37   healthy   vascular  EC_4     23 14782</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/healthy-diseased/seurat-raw.Rds&quot;</span>)</span></code></pre></div>
</div>
<div id="qc" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> QC</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/seurat-raw.Rds&quot;</span>)</span></code></pre></div>
<div id="cell-cycle" class="section level3" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Cell cycle</h3>
<p>Cell cycle scores are estimated to determine cell cycle phase.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>sg <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(cc.genes<span class="sc">$</span>s.genes)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>g2mg <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_to_title</span>(cc.genes<span class="sc">$</span>g2m.genes)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">CellCycleScoring</span>(s,<span class="at">s.features=</span>sg,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>                       <span class="at">g2m.features=</span>g2mg,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">set.ident=</span><span class="cn">FALSE</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>cc_diff <span class="ot">&lt;-</span> s<span class="sc">$</span>S.Score<span class="sc">-</span>s<span class="sc">$</span>G2M.Score</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>Phase))</span></code></pre></div>
<pre><code>  Var1  Freq
1   G1 55430
2  G2M 19945
3    S 11944</code></pre>
</div>
<div id="doubletfinder" class="section level3" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> DoubletFinder</h3>
<p>DoubletFinder is run on each sample separately to estimate doublets in the data.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#devtools::install_github(&quot;chris-mcginnis-ucsf/DoubletFinder&quot;)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DoubletFinder)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>fn_df <span class="ot">&lt;-</span> <span class="cf">function</span>(obj) {</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  obj <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(obj, <span class="at">verbose=</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">NormalizeData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ScaleData</span>(<span class="at">verbose=</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">RunPCA</span>(<span class="at">verbose=</span>F,<span class="at">npcs=</span><span class="dv">20</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">RunTSNE</span>(<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,<span class="at">verbose=</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">RunUMAP</span>(<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,<span class="at">verbose=</span>F)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  psweep <span class="ot">&lt;-</span> <span class="fu">paramSweep_v3</span>(obj,<span class="at">PCs=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>,<span class="at">sct=</span>F)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  ssweep <span class="ot">&lt;-</span> <span class="fu">summarizeSweep</span>(psweep,<span class="at">GT=</span><span class="cn">FALSE</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  bcmvn <span class="ot">&lt;-</span> <span class="fu">find.pK</span>(ssweep)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  nExp <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">ncol</span>(obj) <span class="sc">*</span> <span class="fl">0.04</span>)  <span class="co"># expect 4% doublets</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  obj <span class="ot">&lt;-</span> <span class="fu">doubletFinder_v3</span>(obj,<span class="at">pN=</span><span class="fl">0.25</span>, <span class="at">pK=</span><span class="fl">0.1</span>,<span class="at">nExp=</span>nExp,<span class="at">PCs=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>df_rate <span class="ot">&lt;-</span> <span class="fu">select</span>(obj[[]],<span class="fu">starts_with</span>(<span class="st">&quot;pANN_&quot;</span>))</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  obj<span class="sc">$</span>df_class <span class="ot">&lt;-</span> <span class="fu">select</span>(obj[[]],<span class="fu">starts_with</span>(<span class="st">&quot;DF.&quot;</span>))</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#obj@meta.data &lt;- select(obj[[]],-starts_with(&quot;pANN_&quot;),-starts_with(&quot;DF.&quot;))</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(obj[[]][,<span class="fu">c</span>(<span class="st">&quot;df_rate&quot;</span>,<span class="st">&quot;df_class&quot;</span>)])</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co"># sample 11 removed because too few cells for default umap perplexity</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">subset</span>(s,<span class="at">subset=</span>sample<span class="sc">!=</span><span class="st">&quot;11&quot;</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>lv <span class="ot">&lt;-</span> <span class="fu">unique</span>(s<span class="sc">$</span>sample)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>lst <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="fu">length</span>(lv))</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(lv)) {</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">&quot;Running &quot;</span>,lv[i],<span class="st">&quot;...&quot;</span>))</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">subset</span>(s,<span class="at">subset=</span>sample<span class="sc">==</span>lv[i])</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  lst[[i]] <span class="ot">&lt;-</span> <span class="fu">fn_df</span>(x)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(lst) <span class="ot">&lt;-</span> lv</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>dfr <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(lst,<span class="at">.id=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dfr,<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/doublet-finder.Rds&quot;</span>)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>df_rate <span class="ot">&lt;-</span> dfr<span class="sc">$</span>df_rate</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df_rate) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(dfr)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>df_class <span class="ot">&lt;-</span> dfr<span class="sc">$</span>df_class</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(df_class) <span class="ot">&lt;-</span> <span class="fu">rownames</span>(dfr)</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>df_rate <span class="ot">&lt;-</span> df_rate</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>df_class <span class="ot">&lt;-</span> df_class</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(s<span class="sc">$</span>df_class)</span></code></pre></div>
<pre><code>Doublet Singlet
   3493   83755</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/healthy-diseased/seurat-raw.Rds&quot;</span>)</span></code></pre></div>
</div>
</div>
<div id="filtering" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Filtering</h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/seurat-raw.Rds&quot;</span>)</span></code></pre></div>
<pre><code>An object of class Seurat
41406 features across 87248 samples within 1 assay
Active assay: RNA (41406 features, 0 variable features)</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>rs <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">1</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">as.data.frame</span>(rs),<span class="st">&quot;cells&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(.,<span class="st">&quot;gene&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">data=</span>.)<span class="sc">+</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x=</span>cells))</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/ui-filtered-histogram.png&quot;</span>,p)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">subset</span>(s, <span class="at">subset =</span> nFeature_RNA <span class="sc">&gt;=</span> <span class="dv">200</span> <span class="sc">&amp;</span> nFeature_RNA <span class="sc">&lt;=</span> <span class="dv">6000</span> <span class="sc">&amp;</span> percent_mito <span class="sc">&lt;</span> <span class="dv">5</span>, <span class="at">features=</span><span class="fu">names</span>(rs[<span class="fu">which</span>(rs<span class="sc">&gt;</span><span class="dv">10</span>)]))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># get genes that are not ribo or mito</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>ftk <span class="ot">&lt;-</span> <span class="fu">rownames</span>(s)[<span class="sc">!</span><span class="fu">grepl</span>(<span class="st">&quot;^Rpl|^Rps|^Mt-&quot;</span>,<span class="fu">rownames</span>(s))]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>ctd <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/cells-to-discard.Rds&quot;</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>ctk <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">colnames</span>(s),<span class="fu">intersect</span>(ctd,<span class="fu">colnames</span>(s)))</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">subset</span>(s,<span class="at">features=</span>ftk,<span class="at">cells=</span>ctk)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(<span class="fu">as.character</span>(s<span class="sc">$</span>sample))))</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>orig.ident,s<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>)</span></code></pre></div>
<pre><code>An object of class Seurat 
16181 features across 74192 samples within 1 assay 
Active assay: RNA (16181 features, 0 variable features)

#   orig   id cells
1      1   01   517
2     10   02   376
3     12   03  1022
4     13   04   132
5     17   05   387
6      2   06   492
7      4   07  1150
8      5   08   628
9      6   09  1322
10     7   10   459
11     9   12  1706
12 Ctrl1   13    19
13 Ctrl2   14    71
14 Ctrl3   15   308
15    E1   16  3505
16    E2   17  3293
17    E3   18  1657
18    E4   19  3258
19  EC_1   20   305
20  EC_2   21   569
21  EC_3   22 13232
22  EC_4   23 12271
23    P1   24  3880
24    P2   25  4491
25    P3   26  4678
26 Psor1   27   255
27 Psor2   28   191
28 Psor3   29   353
29    s1   30  4834
30    S1   31   183
31    s2   32  4523
32    S2   33   319
33    s3   34  2547
34    S3   35   611
35    S4   36   246
36    S5   37   402</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove samples with too few cells</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">subset</span>(s,<span class="at">subset=</span>sample <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;13&quot;</span>,<span class="st">&quot;14&quot;</span>),<span class="at">invert=</span><span class="cn">TRUE</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co"># add ribo, mt counts</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">PercentageFeatureSet</span>(s, <span class="st">&quot;^Mt-&quot;</span>, <span class="at">col.name =</span> <span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">PercentageFeatureSet</span>(s, <span class="st">&quot;^Rpl|^Rps&quot;</span>, <span class="at">col.name =</span> <span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(<span class="fu">as.character</span>(s<span class="sc">$</span>sample))))</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/healthy-diseased/full/seurat-filtered.Rds&quot;</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>orig.ident,s<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;orig.ident&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(.,<span class="st">&quot;data/processed/healthy-diseased/full/cell-ids.Rds&quot;</span>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>study))</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition))</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>orig.ident,s<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>)</span></code></pre></div>
<pre><code>An object of class Seurat 
16181 features across 74102 samples within 1 assay 
Active assay: RNA (16181 features, 0 variable features)

1      aging  1761
2     breast 36666
3 dermatitis  8191
4  psoriasis  1107
5   vascular 26377

1 diseased 27657
2  healthy 46445

#   orig   id cells
1      1   01   517
2     10   02   376
3     12   03  1022
4     13   04   132
5     17   05   387
6      2   06   492
7      4   07  1150
8      5   08   628
9      6   09  1322
10     7   10   459
11     9   12  1706
12 Ctrl3   15   308
13    E1   16  3505
14    E2   17  3293
15    E3   18  1657
16    E4   19  3258
17  EC_1   20   305
18  EC_2   21   569
19  EC_3   22 13232
20  EC_4   23 12271
21    P1   24  3880
22    P2   25  4491
23    P3   26  4678
24 Psor1   27   255
25 Psor2   28   191
26 Psor3   29   353
27    s1   30  4834
28    S1   31   183
29    s2   32  4523
30    S2   33   319
31    s3   34  2547
32    S3   35   611
33    S4   36   246
34    S5   37   402</code></pre>
</div>
<div id="unintegrated" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Unintegrated</h2>
<p>UMAP layout and QC of unintegrated dataset</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/full/seurat-filtered.Rds&quot;</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s) <span class="sc">%&gt;%</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">FindVariableFeatures</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ScaleData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunPCA</span>(<span class="at">verbose=</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunUMAP</span>(<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code></pre></div>
<div id="qc-1" class="section level3" number="2.4.1">
<h3><span class="header-section-number">2.4.1</span> QC</h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">VlnPlot</span>(s,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;nCount_RNA&quot;</span>,<span class="st">&quot;nFeature_RNA&quot;</span>,<span class="st">&quot;percent_mito&quot;</span>,<span class="st">&quot;percent_ribo&quot;</span>,<span class="st">&quot;df_rate&quot;</span>),<span class="at">pt.size=</span><span class="dv">0</span>,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>)<span class="sc">&amp;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_report</span>()<span class="sc">&amp;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x=</span><span class="fu">element_blank</span>())</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/ui-filtered-qc-violin.png&quot;</span>,p,<span class="at">height=</span><span class="dv">9</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">14</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>) <span class="sc">&amp;</span> <span class="fu">coord_fixed</span>()</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/ui-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/ui-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">6</span>)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/ui-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/ui-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/ui-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/ui-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">8</span>)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>, <span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/ui-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/healthy-diseased/full/unintegrated/seurat-unintegrated.Rds&quot;</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy-diseased/full/unintegrated/ui-filtered-qc-violin.png" /></p>
<p><b>Fig. </b> 1: <em>Violin plot showing QC metrics.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/unintegrated/ui-umap-sample.png" /></p>
<p><b>Fig. </b> 2: <em>UMAP scatterplot of unintegrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/unintegrated/ui-umap-qc.png" /></p>
<p><b>Fig. </b> 3: <em>QC plots of unintegrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/unintegrated/ui-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 4: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/unintegrated/ui-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 5: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/unintegrated/ui-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 6: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/unintegrated/ui-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 7: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/unintegrated/ui-umap-known-markers.png" /></p>
<p><b>Fig. </b> 8: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="integration" class="section level2" number="2.5">
<h2><span class="header-section-number">2.5</span> Integration</h2>
<p>Data is integrated across samples (individuals). Normalisation is carried out separately for each individual.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/full/seurat-filtered.Rds&quot;</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>s.list <span class="ot">&lt;-</span> <span class="fu">SplitObject</span>(s,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(s.list)) {</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s.list[[i]],<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">normalization.method=</span><span class="st">&quot;LogNormalize&quot;</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(s.list[[i]], <span class="at">selection.method=</span><span class="st">&quot;vst&quot;</span>, <span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>s.features <span class="ot">&lt;-</span> <span class="fu">SelectIntegrationFeatures</span>(s.list,<span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>s.anchors <span class="ot">&lt;-</span> <span class="fu">FindIntegrationAnchors</span>(<span class="at">object.list=</span>s.list,<span class="at">anchor.features=</span>s.features)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">IntegrateData</span>(<span class="at">anchorset=</span>s.anchors)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(ss) <span class="ot">&lt;-</span> <span class="st">&quot;integrated&quot;</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(ss)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(ss,<span class="at">verbose=</span>F,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(ss,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;Writing data&quot;</span>)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/healthy-diseased/full/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
</div>
<div id="integrated" class="section level2" number="2.6">
<h2><span class="header-section-number">2.6</span> Integrated</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/seurat-integrated-separate.Rds&quot;</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(ss<span class="sc">$</span>condition,ss<span class="sc">$</span>study,ss<span class="sc">$</span>orig.ident,ss<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<p>Conditions, individual IDs (original and new), datasets and counts of cells.</p>
<pre><code>   condition      study   ind sample cells
1   diseased     breast    E1     15  3505
2   diseased     breast    E2     16  3293
3   diseased     breast    E3     17  1657
4   diseased     breast    E4     18  3258
5   diseased     breast    P1     23  3880
6   diseased     breast    P2     24  4491
7   diseased     breast    P3     25  4678
8   diseased dermatitis     1     01   517
9   diseased dermatitis     2     06   492
10  diseased dermatitis     5     08   628
11  diseased dermatitis     7     10   459
12  diseased  psoriasis Psor1     26   255
13  diseased  psoriasis Psor2     27   191
14  diseased  psoriasis Psor3     28   353
15   healthy      aging    S1     30   183
16   healthy      aging    S2     32   319
17   healthy      aging    S3     34   611
18   healthy      aging    S4     35   246
19   healthy      aging    S5     36   402
20   healthy     breast    s1     29  4834
21   healthy     breast    s2     31  4523
22   healthy     breast    s3     33  2547
23   healthy dermatitis    10     02   376
24   healthy dermatitis    12     03  1022
25   healthy dermatitis    13     04   132
26   healthy dermatitis    17     05   387
27   healthy dermatitis     4     07  1150
28   healthy dermatitis     6     09  1322
29   healthy dermatitis     9     11  1706
30   healthy  psoriasis Ctrl3     14   308
31   healthy   vascular  EC_1     19   305
32   healthy   vascular  EC_2     20   569
33   healthy   vascular  EC_3     21 13232
34   healthy   vascular  EC_4     22 12271</code></pre>
<div id="qc-2" class="section level3" number="2.6.1">
<h3><span class="header-section-number">2.6.1</span> QC</h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>)<span class="sc">&amp;</span><span class="fu">coord_fixed</span>()</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/is-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/is-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/is-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/is-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/is-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/is-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">5</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>,<span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/is-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy-diseased/full/integrated/is-umap-sample.png" /></p>
<p><b>Fig. </b> 9: <em>UMAP scatterplot of integrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/integrated/is-umap-qc.png" /></p>
<p><b>Fig. </b> 10: <em>QC plots of integrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/integrated/is-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 11: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/integrated/is-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 12: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/integrated/is-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 13: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/integrated/is-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 14: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/integrated/is-umap-known-markers.png" /></p>
<p><b>Fig. </b> 15: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="clustering" class="section level2" number="2.7">
<h2><span class="header-section-number">2.7</span> Clustering</h2>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(ss,<span class="at">reduction=</span><span class="st">&quot;pca&quot;</span>,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(ss,<span class="at">resolution=</span><span class="fl">0.1</span>,<span class="at">random.seed=</span><span class="dv">100</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>, <span class="fu">as.integer</span>(ss<span class="sc">$</span>seurat_clusters)))</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">factor</span>(ids,<span class="at">levels=</span><span class="fu">sort</span>(<span class="fu">unique</span>(ids)))</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ids) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(ss)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>ss[[<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids))))]] <span class="ot">&lt;-</span> ids</span></code></pre></div>
<div id="markers" class="section level3" number="2.7.1">
<h3><span class="header-section-number">2.7.1</span> Markers</h3>
<p>Marker genes are identified for each cluster group.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write marker genes</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>cid <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids)))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(ss) <span class="ot">&lt;-</span> ss[[]][,<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,cid)]</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">FindAllMarkers</span>(ss,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">test.use=</span><span class="st">&quot;MAST&quot;</span>,<span class="at">only.pos=</span><span class="cn">TRUE</span>,<span class="at">min.pct=</span><span class="fl">0.25</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">logfc.threshold=</span><span class="fl">0.25</span>,<span class="at">max.cells.per.ident=</span><span class="dv">200</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">min.cells.group=</span><span class="dv">10</span>,<span class="at">random.seed=</span><span class="dv">100</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>   <span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;data&quot;</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">latent.vars=</span><span class="fu">c</span>(<span class="st">&quot;nCount_RNA&quot;</span>,<span class="st">&quot;sample&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(p_val_adj<span class="sc">&lt;</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster,<span class="sc">-</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(temp,<span class="at">path=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>))</span></code></pre></div>
<p>Top 10 marker genes are visualised as dotplot and heatmap.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">n=</span><span class="dv">10</span>,<span class="at">order_by=</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;cluster_08&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-umap.png&quot;</span>),p,<span class="at">height=</span><span class="dv">7</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DotPlot</span>(ss,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene))<span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>()<span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_report</span>()<span class="sc">+</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;right&quot;</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.direction=</span><span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.title=</span><span class="fu">element_blank</span>())</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-dotplot.png&quot;</span>),p,<span class="at">height=</span><span class="dv">11</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(ss,<span class="at">downsample=</span><span class="dv">100</span>),<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene),<span class="at">assay=</span><span class="st">&quot;integrated&quot;</span>)<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-heatmap.png&quot;</span>),p,<span class="at">height=</span><span class="fu">nrow</span>(m1)<span class="sc">*</span><span class="fl">0.18</span>,<span class="at">width=</span><span class="dv">8</span>,<span class="at">limitsize=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy-diseased/full/integrated/clustering/markers-clusters-08-umap.png" /></p>
<p><b>Fig. </b> 16: <em>UMAP showing clusters.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/integrated/clustering/markers-clusters-08-dotplot.png" /></p>
<p><b>Fig. </b> 17: <em>Dotplot of top marker genes.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/full/integrated/clustering/markers-clusters-08-heatmap.png" /></p>
<p><b>Fig. </b> 18: <em>Heatmap of top marker genes.</em></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/healthy-diseased/full/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>hf <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;data/processed/healthy-diseased/full/integrated/clustering/optimising/markers/&quot;</span>,<span class="st">&quot;.png&quot;</span>,<span class="at">full.names=</span>T)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(hf)</span></code></pre></div>
<hr />
</div>
</div>
</div>
<div id="healthy-diseased-ad" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Healthy-Diseased-AD</h1>
<ul>
<li>Healthy samples:
<ul>
<li>Dataset 1.1 “Breast” sample IDs: s1, s2, s3</li>
<li>Dataset 2 “Vascular” sample IDs: EC_1, EC_2, EC_3, EC_4</li>
<li>Dataset 3 “Aging” sample IDs: S1, S2, S3, S4, S5</li>
<li>Dataset 6.1 “Psoriasis” sample IDs: Ctrl1, Ctrl2, Ctrl3</li>
<li>Dataset 7.1 “Dermatitis” sample IDs: 4, 6, 8, 9, 10, 12, 13, 17</li>
</ul></li>
<li>Diseased AD samples:
<ul>
<li>Dataset 1.2 “Breast” sample IDs: E1, E2, E3, E4</li>
<li>Dataset 7.2 “Dermatitis” sample IDs: 1, 2, 5, 7</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/full/seurat-filtered.Rds&quot;</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">subset</span>(s,<span class="at">subset=</span>orig.ident <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;s2&quot;</span>,<span class="st">&quot;s3&quot;</span>,<span class="st">&quot;s1&quot;</span>,<span class="st">&quot;E2&quot;</span>,<span class="st">&quot;E3&quot;</span>,<span class="st">&quot;E4&quot;</span>,<span class="st">&quot;E1&quot;</span>,<span class="st">&quot;Ctrl1&quot;</span>,<span class="st">&quot;Ctrl3&quot;</span>,<span class="st">&quot;Ctrl2&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;6&quot;</span>,<span class="st">&quot;9&quot;</span>,<span class="st">&quot;10&quot;</span>,<span class="st">&quot;12&quot;</span>,<span class="st">&quot;13&quot;</span>,<span class="st">&quot;17&quot;</span>,<span class="st">&quot;1&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;5&quot;</span>,<span class="st">&quot;7&quot;</span>,<span class="st">&quot;S1&quot;</span>,<span class="st">&quot;S2&quot;</span>,<span class="st">&quot;S3&quot;</span>,<span class="st">&quot;S4&quot;</span>,<span class="st">&quot;S5&quot;</span>,<span class="st">&quot;EC_1&quot;</span>,<span class="st">&quot;EC_2&quot;</span>,<span class="st">&quot;EC_3&quot;</span>,<span class="st">&quot;EC_4&quot;</span>)),<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(<span class="fu">as.character</span>(s<span class="sc">$</span>sample))))</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>study))</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition))</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>sample))</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition,s<span class="sc">$</span>study,s<span class="sc">$</span>orig.ident,s<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<pre><code>An object of class Seurat 
16181 features across 60254 samples within 1 assay 
Active assay: RNA (16181 features, 0 variable features)</code></pre>
<pre><code>1      aging  1761
2     breast 23617
3 dermatitis  8191
4  psoriasis   308
5   vascular 26377

1 diseased 13809
2  healthy 46445

1    01   517
2    02   376
3    03  1022
4    04   132
5    05   387
6    06   492
7    07  1150
8    08   628
9    09  1322
10   10   459
11   12  1706
12   15   308
13   16  3505
14   17  3293
15   18  1657
16   19  3258
17   20   305
18   21   569
19   22 13232
20   23 12271
21   30  4834
22   31   183
23   32  4523
24   33   319
25   34  2547
26   35   611
27   36   246
28   37   402

   condition      study   ind sample cells
1   diseased     breast    E1     16  3505
2   diseased     breast    E2     17  3293
3   diseased     breast    E3     18  1657
4   diseased     breast    E4     19  3258
5   diseased dermatitis     1     01   517
6   diseased dermatitis     2     06   492
7   diseased dermatitis     5     08   628
8   diseased dermatitis     7     10   459
9    healthy      aging    S1     31   183
10   healthy      aging    S2     33   319
11   healthy      aging    S3     35   611
12   healthy      aging    S4     36   246
13   healthy      aging    S5     37   402
14   healthy     breast    s1     30  4834
15   healthy     breast    s2     32  4523
16   healthy     breast    s3     34  2547
17   healthy dermatitis    10     02   376
18   healthy dermatitis    12     03  1022
19   healthy dermatitis    13     04   132
20   healthy dermatitis    17     05   387
21   healthy dermatitis     4     07  1150
22   healthy dermatitis     6     09  1322
23   healthy dermatitis     9     12  1706
24   healthy  psoriasis Ctrl3     15   308
25   healthy   vascular  EC_1     20   305
26   healthy   vascular  EC_2     21   569
27   healthy   vascular  EC_3     22 13232
28   healthy   vascular  EC_4     23 12271</code></pre>
<div id="unintegrated-1" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> Unintegrated</h2>
<p>UMAP layout and QC of unintegrated dataset</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s) <span class="sc">%&gt;%</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">FindVariableFeatures</span>() <span class="sc">%&gt;%</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ScaleData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunPCA</span>(<span class="at">verbose=</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunUMAP</span>(<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code></pre></div>
<div id="qc-3" class="section level3" number="3.1.1">
<h3><span class="header-section-number">3.1.1</span> QC</h3>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>) <span class="sc">&amp;</span> <span class="fu">coord_fixed</span>()</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/unintegrated/ui-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/unintegrated/ui-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">6</span>)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/unintegrated/ui-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/unintegrated/ui-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/unintegrated/ui-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/unintegrated/ui-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">8</span>)</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>, <span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/unintegrated/ui-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/healthy-diseased/ad/unintegrated/seurat-unintegrated.Rds&quot;</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/unintegrated/ui-umap-sample.png" /></p>
<p><b>Fig. </b> 19: <em>UMAP scatterplot of unintegrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/unintegrated/ui-umap-qc.png" /></p>
<p><b>Fig. </b> 20: <em>QC plots of unintegrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/unintegrated/ui-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 21: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/unintegrated/ui-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 22: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/unintegrated/ui-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 23: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/unintegrated/ui-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 24: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/unintegrated/ui-umap-known-markers.png" /></p>
<p><b>Fig. </b> 25: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="integration-1" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Integration</h2>
<p>Data is integrated across samples (individuals). Normalisation is carried out separately for each individual.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/full/seurat-filtered.Rds&quot;</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">subset</span>(s,<span class="at">subset=</span>orig.ident <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;s2&quot;</span>,<span class="st">&quot;s3&quot;</span>,<span class="st">&quot;s1&quot;</span>,<span class="st">&quot;E2&quot;</span>,<span class="st">&quot;E3&quot;</span>,<span class="st">&quot;E4&quot;</span>,<span class="st">&quot;E1&quot;</span>,<span class="st">&quot;Ctrl1&quot;</span>,<span class="st">&quot;Ctrl3&quot;</span>,<span class="st">&quot;Ctrl2&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;6&quot;</span>,<span class="st">&quot;9&quot;</span>,<span class="st">&quot;10&quot;</span>,<span class="st">&quot;12&quot;</span>,<span class="st">&quot;13&quot;</span>,<span class="st">&quot;17&quot;</span>,<span class="st">&quot;1&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;5&quot;</span>,<span class="st">&quot;7&quot;</span>,<span class="st">&quot;S1&quot;</span>,<span class="st">&quot;S2&quot;</span>,<span class="st">&quot;S3&quot;</span>,<span class="st">&quot;S4&quot;</span>,<span class="st">&quot;S5&quot;</span>,<span class="st">&quot;EC_1&quot;</span>,<span class="st">&quot;EC_2&quot;</span>,<span class="st">&quot;EC_3&quot;</span>,<span class="st">&quot;EC_4&quot;</span>)),<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(s<span class="sc">$</span>sample)))</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>s.list <span class="ot">&lt;-</span> <span class="fu">SplitObject</span>(s,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(s.list)) {</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s.list[[i]],<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">normalization.method=</span><span class="st">&quot;LogNormalize&quot;</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(s.list[[i]], <span class="at">selection.method=</span><span class="st">&quot;vst&quot;</span>, <span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>s.features <span class="ot">&lt;-</span> <span class="fu">SelectIntegrationFeatures</span>(s.list,<span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>s.anchors <span class="ot">&lt;-</span> <span class="fu">FindIntegrationAnchors</span>(<span class="at">object.list=</span>s.list,<span class="at">anchor.features=</span>s.features)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">IntegrateData</span>(<span class="at">anchorset=</span>s.anchors)</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(ss) <span class="ot">&lt;-</span> <span class="st">&quot;integrated&quot;</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(ss)</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(ss,<span class="at">verbose=</span>F,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(ss,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;Writing data&quot;</span>)</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
</div>
<div id="integrated-1" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> Integrated</h2>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/seurat-integrated-separate.Rds&quot;</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(ss<span class="sc">$</span>condition,ss<span class="sc">$</span>study,ss<span class="sc">$</span>orig.ident,ss<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<p>Conditions, individual IDs (original and new), datasets and counts of cells.</p>
<pre><code>   condition      study   ind sample cells
1   diseased     breast    E1     16  3505
2   diseased     breast    E2     17  3293
3   diseased     breast    E3     18  1657
4   diseased     breast    E4     19  3258
5   diseased dermatitis     1     01   517
6   diseased dermatitis     2     06   492
7   diseased dermatitis     5     08   628
8   diseased dermatitis     7     10   459
9    healthy      aging    S1     31   183
10   healthy      aging    S2     33   319
11   healthy      aging    S3     35   611
12   healthy      aging    S4     36   246
13   healthy      aging    S5     37   402
14   healthy     breast    s1     30  4834
15   healthy     breast    s2     32  4523
16   healthy     breast    s3     34  2547
17   healthy dermatitis    10     02   376
18   healthy dermatitis    12     03  1022
19   healthy dermatitis    13     04   132
20   healthy dermatitis    17     05   387
21   healthy dermatitis     4     07  1150
22   healthy dermatitis     6     09  1322
23   healthy dermatitis     9     12  1706
24   healthy  psoriasis Ctrl3     15   308
25   healthy   vascular  EC_1     20   305
26   healthy   vascular  EC_2     21   569
27   healthy   vascular  EC_3     22 13232
28   healthy   vascular  EC_4     23 12271</code></pre>
<div id="qc-4" class="section level3" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> QC</h3>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>)<span class="sc">&amp;</span><span class="fu">coord_fixed</span>()</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/is-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/is-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/is-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/is-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/is-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/is-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">5</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>,<span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/is-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/integrated/is-umap-sample.png" /></p>
<p><b>Fig. </b> 26: <em>UMAP scatterplot of integrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/integrated/is-umap-qc.png" /></p>
<p><b>Fig. </b> 27: <em>QC plots of integrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/integrated/is-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 28: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/integrated/is-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 29: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/integrated/is-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 30: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/integrated/is-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 31: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/integrated/is-umap-known-markers.png" /></p>
<p><b>Fig. </b> 32: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="clustering-1" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> Clustering</h2>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(ss,<span class="at">reduction=</span><span class="st">&quot;pca&quot;</span>,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(ss,<span class="at">resolution=</span><span class="fl">0.055</span>,<span class="at">random.seed=</span><span class="dv">100</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>, <span class="fu">as.integer</span>(ss<span class="sc">$</span>seurat_clusters)))</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">factor</span>(ids,<span class="at">levels=</span><span class="fu">sort</span>(<span class="fu">unique</span>(ids)))</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ids) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(ss)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>ss[[<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids))))]] <span class="ot">&lt;-</span> ids</span></code></pre></div>
<div id="markers-1" class="section level3" number="3.4.1">
<h3><span class="header-section-number">3.4.1</span> Markers</h3>
<p>Marker genes are identified for each cluster group.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write marker genes</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>cid <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids)))</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(ss) <span class="ot">&lt;-</span> ss[[]][,<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,cid)]</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">FindAllMarkers</span>(ss,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">test.use=</span><span class="st">&quot;MAST&quot;</span>,<span class="at">only.pos=</span><span class="cn">TRUE</span>,<span class="at">min.pct=</span><span class="fl">0.25</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">logfc.threshold=</span><span class="fl">0.25</span>,<span class="at">max.cells.per.ident=</span><span class="dv">200</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">min.cells.group=</span><span class="dv">10</span>,<span class="at">random.seed=</span><span class="dv">100</span>,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>   <span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;data&quot;</span>,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">latent.vars=</span><span class="fu">c</span>(<span class="st">&quot;nCount_RNA&quot;</span>,<span class="st">&quot;sample&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(p_val_adj<span class="sc">&lt;</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster,<span class="sc">-</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(temp,<span class="at">path=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>))</span></code></pre></div>
<p>Top 10 marker genes are visualised as dotplot and heatmap.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">n=</span><span class="dv">10</span>,<span class="at">order_by=</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;cluster_08&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-umap.png&quot;</span>),p,<span class="at">height=</span><span class="dv">7</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DotPlot</span>(ss,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene))<span class="sc">+</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>()<span class="sc">+</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_report</span>()<span class="sc">+</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;right&quot;</span>,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.direction=</span><span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.title=</span><span class="fu">element_blank</span>())</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-dotplot.png&quot;</span>),p,<span class="at">height=</span><span class="dv">11</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(ss,<span class="at">downsample=</span><span class="dv">100</span>),<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene),<span class="at">assay=</span><span class="st">&quot;integrated&quot;</span>)<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-heatmap.png&quot;</span>),p,<span class="at">height=</span><span class="fu">nrow</span>(m1)<span class="sc">*</span><span class="fl">0.18</span>,<span class="at">width=</span><span class="dv">8</span>,<span class="at">limitsize=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/integrated/clustering/markers-clusters-08-umap.png" /></p>
<p><b>Fig. </b> 33: <em>UMAP showing clusters.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/integrated/clustering/markers-clusters-08-dotplot.png" /></p>
<p><b>Fig. </b> 34: <em>Dotplot of top marker genes.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/ad/integrated/clustering/markers-clusters-08-heatmap.png" /></p>
<p><b>Fig. </b> 35: <em>Heatmap of top marker genes.</em></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>hf <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;data/processed/healthy-diseased/ad/integrated/clustering/optimising/markers/&quot;</span>,<span class="st">&quot;.png&quot;</span>,<span class="at">full.names=</span>T)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(hf)</span></code></pre></div>
<hr />
</div>
</div>
</div>
<div id="healthy-diseased-p" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Healthy-Diseased-P</h1>
<ul>
<li>Healthy samples:
<ul>
<li>Dataset 1.1 “Breast” sample IDs: s1, s2, s3</li>
<li>Dataset 2 “Vascular” sample IDs: EC_1, EC_2, EC_3, EC_4</li>
<li>Dataset 3 “Aging” sample IDs: S1, S2, S3, S4, S5</li>
<li>Dataset 6.1 “Psoriasis” sample IDs: Ctrl1, Ctrl2, Ctrl3</li>
<li>Dataset 7.1 “Dermatitis” sample IDs: 4, 6, 8, 9, 10, 12, 13, 17</li>
</ul></li>
<li>Diseased P samples:
<ul>
<li>Dataset 1.2 “Breast” sample IDs: P1, P2, P3</li>
<li>Dataset 6.2 “Psoriasis” sample IDs: Psor1, Psor2, Psor3</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/full/seurat-filtered.Rds&quot;</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">subset</span>(s,<span class="at">subset=</span>orig.ident <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;s2&quot;</span>,<span class="st">&quot;s3&quot;</span>,<span class="st">&quot;s1&quot;</span>,<span class="st">&quot;P1&quot;</span>,<span class="st">&quot;P2&quot;</span>,<span class="st">&quot;P3&quot;</span>,<span class="st">&quot;Ctrl1&quot;</span>,<span class="st">&quot;Ctrl3&quot;</span>,<span class="st">&quot;Ctrl2&quot;</span>,<span class="st">&quot;Psor3&quot;</span>,<span class="st">&quot;Psor1&quot;</span>,<span class="st">&quot;Psor2&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;6&quot;</span>,<span class="st">&quot;9&quot;</span>,<span class="st">&quot;10&quot;</span>,<span class="st">&quot;12&quot;</span>,<span class="st">&quot;13&quot;</span>,<span class="st">&quot;17&quot;</span>,<span class="st">&quot;S1&quot;</span>,<span class="st">&quot;S2&quot;</span>,<span class="st">&quot;S3&quot;</span>,<span class="st">&quot;S4&quot;</span>,<span class="st">&quot;S5&quot;</span>,<span class="st">&quot;EC_1&quot;</span>,<span class="st">&quot;EC_2&quot;</span>,<span class="st">&quot;EC_3&quot;</span>,<span class="st">&quot;EC_4&quot;</span>)),<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(<span class="fu">as.character</span>(s<span class="sc">$</span>sample))))</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>study))</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition))</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>sample))</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition,s<span class="sc">$</span>study,s<span class="sc">$</span>orig.ident,s<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<p>Overview of full dataset.</p>
<pre><code>An object of class Seurat 
16181 features across 60293 samples within 1 assay 
Active assay: RNA (16181 features, 0 variable features)

1      aging  1761
2     breast 24953
3 dermatitis  6095
4  psoriasis  1107
5   vascular 26377

1 diseased 13848
2  healthy 46445

1    02   376
2    03  1022
3    04   132
4    05   387
5    07  1150
6    09  1322
7    12  1706
8    15   308
9    20   305
10   21   569
11   22 13232
12   23 12271
13   24  3880
14   25  4491
15   26  4678
16   27   255
17   28   191
18   29   353
19   30  4834
20   31   183
21   32  4523
22   33   319
23   34  2547
24   35   611
25   36   246
26   37   402

   condition      study   ind sample cells
1   diseased     breast    P1     24  3880
2   diseased     breast    P2     25  4491
3   diseased     breast    P3     26  4678
4   diseased  psoriasis Psor1     27   255
5   diseased  psoriasis Psor2     28   191
6   diseased  psoriasis Psor3     29   353
7    healthy      aging    S1     31   183
8    healthy      aging    S2     33   319
9    healthy      aging    S3     35   611
10   healthy      aging    S4     36   246
11   healthy      aging    S5     37   402
12   healthy     breast    s1     30  4834
13   healthy     breast    s2     32  4523
14   healthy     breast    s3     34  2547
15   healthy dermatitis    10     02   376
16   healthy dermatitis    12     03  1022
17   healthy dermatitis    13     04   132
18   healthy dermatitis    17     05   387
19   healthy dermatitis     4     07  1150
20   healthy dermatitis     6     09  1322
21   healthy dermatitis     9     12  1706
22   healthy  psoriasis Ctrl3     15   308
23   healthy   vascular  EC_1     20   305
24   healthy   vascular  EC_2     21   569
25   healthy   vascular  EC_3     22 13232
26   healthy   vascular  EC_4     23 12271</code></pre>
<div id="unintegrated-2" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Unintegrated</h2>
<p>UMAP layout and QC of unintegrated dataset.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s) <span class="sc">%&gt;%</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">FindVariableFeatures</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ScaleData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunPCA</span>(<span class="at">verbose=</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunUMAP</span>(<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code></pre></div>
<div id="qc-5" class="section level3" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> QC</h3>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>) <span class="sc">&amp;</span> <span class="fu">coord_fixed</span>()</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/unintegrated/ui-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/unintegrated/ui-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">6</span>)</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/unintegrated/ui-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/unintegrated/ui-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/unintegrated/ui-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/unintegrated/ui-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">8</span>)</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>, <span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/unintegrated/ui-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/healthy-diseased/p/unintegrated/seurat-unintegrated.Rds&quot;</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy-diseased/p/unintegrated/ui-umap-sample.png" /></p>
<p><b>Fig. </b> 36: <em>UMAP scatterplot of unintegrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/unintegrated/ui-umap-qc.png" /></p>
<p><b>Fig. </b> 37: <em>QC plots of unintegrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/unintegrated/ui-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 38: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/unintegrated/ui-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 39: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/unintegrated/ui-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 40: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/unintegrated/ui-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 41: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/unintegrated/ui-umap-known-markers.png" /></p>
<p><b>Fig. </b> 42: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="integration-2" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Integration</h2>
<p>Data is integrated across samples (individuals). Normalisation is carried out separately for each individual.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/full/seurat-filtered.Rds&quot;</span>)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">subset</span>(s,<span class="at">subset=</span>orig.ident <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;s2&quot;</span>,<span class="st">&quot;s3&quot;</span>,<span class="st">&quot;s1&quot;</span>,<span class="st">&quot;P1&quot;</span>,<span class="st">&quot;P2&quot;</span>,<span class="st">&quot;P3&quot;</span>,<span class="st">&quot;Ctrl1&quot;</span>,<span class="st">&quot;Ctrl3&quot;</span>,<span class="st">&quot;Ctrl2&quot;</span>,<span class="st">&quot;Psor3&quot;</span>,<span class="st">&quot;Psor1&quot;</span>,<span class="st">&quot;Psor2&quot;</span>,<span class="st">&quot;4&quot;</span>,<span class="st">&quot;6&quot;</span>,<span class="st">&quot;9&quot;</span>,<span class="st">&quot;10&quot;</span>,<span class="st">&quot;12&quot;</span>,<span class="st">&quot;13&quot;</span>,<span class="st">&quot;17&quot;</span>,<span class="st">&quot;S1&quot;</span>,<span class="st">&quot;S2&quot;</span>,<span class="st">&quot;S3&quot;</span>,<span class="st">&quot;S4&quot;</span>,<span class="st">&quot;S5&quot;</span>,<span class="st">&quot;EC_1&quot;</span>,<span class="st">&quot;EC_2&quot;</span>,<span class="st">&quot;EC_3&quot;</span>,<span class="st">&quot;EC_4&quot;</span>)),<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(s<span class="sc">$</span>sample)))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>s.list <span class="ot">&lt;-</span> <span class="fu">SplitObject</span>(s,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(s.list)) {</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s.list[[i]],<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">normalization.method=</span><span class="st">&quot;LogNormalize&quot;</span>)</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(s.list[[i]], <span class="at">selection.method=</span><span class="st">&quot;vst&quot;</span>, <span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>s.features <span class="ot">&lt;-</span> <span class="fu">SelectIntegrationFeatures</span>(s.list,<span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>s.anchors <span class="ot">&lt;-</span> <span class="fu">FindIntegrationAnchors</span>(<span class="at">object.list=</span>s.list,<span class="at">anchor.features=</span>s.features)</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">IntegrateData</span>(<span class="at">anchorset=</span>s.anchors)</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(ss) <span class="ot">&lt;-</span> <span class="st">&quot;integrated&quot;</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(ss)</span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(ss,<span class="at">verbose=</span>F,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(ss,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;Writing data&quot;</span>)</span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/healthy-diseased/p/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
</div>
<div id="integrated-2" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Integrated</h2>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/seurat-integrated-separate.Rds&quot;</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(ss<span class="sc">$</span>condition,ss<span class="sc">$</span>study,ss<span class="sc">$</span>orig.ident,ss<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<p>Conditions, individual IDs (original and new), datasets and counts of cells.</p>
<pre><code>   condition      study   ind sample cells
1   diseased     breast    P1     24  3880
2   diseased     breast    P2     25  4491
3   diseased     breast    P3     26  4678
4   diseased  psoriasis Psor1     27   255
5   diseased  psoriasis Psor2     28   191
6   diseased  psoriasis Psor3     29   353
7    healthy      aging    S1     31   183
8    healthy      aging    S2     33   319
9    healthy      aging    S3     35   611
10   healthy      aging    S4     36   246
11   healthy      aging    S5     37   402
12   healthy     breast    s1     30  4834
13   healthy     breast    s2     32  4523
14   healthy     breast    s3     34  2547
15   healthy dermatitis    10     02   376
16   healthy dermatitis    12     03  1022
17   healthy dermatitis    13     04   132
18   healthy dermatitis    17     05   387
19   healthy dermatitis     4     07  1150
20   healthy dermatitis     6     09  1322
21   healthy dermatitis     9     12  1706
22   healthy  psoriasis Ctrl3     15   308
23   healthy   vascular  EC_1     20   305
24   healthy   vascular  EC_2     21   569
25   healthy   vascular  EC_3     22 13232
26   healthy   vascular  EC_4     23 12271
</code></pre>
<div id="qc-6" class="section level3" number="4.3.1">
<h3><span class="header-section-number">4.3.1</span> QC</h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>)<span class="sc">&amp;</span><span class="fu">coord_fixed</span>()</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/is-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/is-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/is-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/is-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/is-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/is-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">5</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>,<span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/is-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy-diseased/p/integrated/is-umap-sample.png" /></p>
<p><b>Fig. </b> 43: <em>UMAP scatterplot of integrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/integrated/is-umap-qc.png" /></p>
<p><b>Fig. </b> 44: <em>QC plots of integrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/integrated/is-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 45: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/integrated/is-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 46: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/integrated/is-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 47: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/integrated/is-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 48: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/integrated/is-umap-known-markers.png" /></p>
<p><b>Fig. </b> 49: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="clustering-2" class="section level2" number="4.4">
<h2><span class="header-section-number">4.4</span> Clustering</h2>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(ss,<span class="at">reduction=</span><span class="st">&quot;pca&quot;</span>,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(ss,<span class="at">resolution=</span><span class="fl">0.02</span>,<span class="at">random.seed=</span><span class="dv">100</span>)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>, <span class="fu">as.integer</span>(ss<span class="sc">$</span>seurat_clusters)))</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">factor</span>(ids,<span class="at">levels=</span><span class="fu">sort</span>(<span class="fu">unique</span>(ids)))</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ids) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(ss)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>ss[[<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids))))]] <span class="ot">&lt;-</span> ids</span></code></pre></div>
<div id="markers-2" class="section level3" number="4.4.1">
<h3><span class="header-section-number">4.4.1</span> Markers</h3>
<p>Marker genes are identified for each cluster group.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write marker genes</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>cid <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids)))</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(ss) <span class="ot">&lt;-</span> ss[[]][,<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,cid)]</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">FindAllMarkers</span>(ss,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">test.use=</span><span class="st">&quot;MAST&quot;</span>,<span class="at">only.pos=</span><span class="cn">TRUE</span>,<span class="at">min.pct=</span><span class="fl">0.25</span>,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">logfc.threshold=</span><span class="fl">0.25</span>,<span class="at">max.cells.per.ident=</span><span class="dv">200</span>,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">min.cells.group=</span><span class="dv">10</span>,<span class="at">random.seed=</span><span class="dv">100</span>,</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>   <span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;data&quot;</span>,</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">latent.vars=</span><span class="fu">c</span>(<span class="st">&quot;nCount_RNA&quot;</span>,<span class="st">&quot;sample&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(p_val_adj<span class="sc">&lt;</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster,<span class="sc">-</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(temp,<span class="at">path=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>))</span></code></pre></div>
<p>Top 10 marker genes are visualised as dotplot and heatmap.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">n=</span><span class="dv">10</span>,<span class="at">order_by=</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;cluster_08&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-umap.png&quot;</span>),p,<span class="at">height=</span><span class="dv">7</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DotPlot</span>(ss,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene))<span class="sc">+</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>()<span class="sc">+</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_report</span>()<span class="sc">+</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;right&quot;</span>,</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.direction=</span><span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.title=</span><span class="fu">element_blank</span>())</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-dotplot.png&quot;</span>),p,<span class="at">height=</span><span class="dv">11</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(ss,<span class="at">downsample=</span><span class="dv">100</span>),<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene),<span class="at">assay=</span><span class="st">&quot;integrated&quot;</span>)<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-heatmap.png&quot;</span>),p,<span class="at">height=</span><span class="fu">nrow</span>(m1)<span class="sc">*</span><span class="fl">0.18</span>,<span class="at">width=</span><span class="dv">8</span>,<span class="at">limitsize=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy-diseased/p/integrated/clustering/markers-clusters-08-umap.png" /></p>
<p><b>Fig. </b> 50: <em>UMAP showing clusters.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/integrated/clustering/markers-clusters-08-dotplot.png" /></p>
<p><b>Fig. </b> 51: <em>Dotplot of top marker genes.</em></p>
<p><img src="markdown_images/data/processed/healthy-diseased/p/integrated/clustering/markers-clusters-08-heatmap.png" /></p>
<p><b>Fig. </b> 52: <em>Heatmap of top marker genes.</em></p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/healthy-diseased/p/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>hf <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;data/processed/healthy-diseased/p/integrated/clustering/optimising/markers/&quot;</span>,<span class="st">&quot;.png&quot;</span>,<span class="at">full.names=</span>T)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(hf)</span></code></pre></div>
</div>
</div>
</div>
<div id="diseased" class="section level1" number="5">
<h1><span class="header-section-number">5</span> Diseased</h1>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/full/seurat-filtered.Rds&quot;</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">subset</span>(s,<span class="at">subset=</span>condition<span class="sc">==</span><span class="st">&quot;diseased&quot;</span>),<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(<span class="fu">as.character</span>(s<span class="sc">$</span>sample))))</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/diseased/seurat-filtered-diseased.Rds&quot;</span>)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>study))</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition))</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>sample))</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition,s<span class="sc">$</span>study,s<span class="sc">$</span>orig.ident,s<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<pre><code>An object of class Seurat 
16181 features across 27657 samples within 1 assay 
Active assay: RNA (16181 features, 0 variable features)

1     breast 24762
2 dermatitis  2096
3  psoriasis   799

1    01  517
2    06  492
3    08  628
4    10  459
5    16 3505
6    17 3293
7    18 1657
8    19 3258
9    24 3880
10   25 4491
11   26 4678
12   27  255
13   28  191
14   29  353

   condition      study   ind sample cells
1   diseased     breast    E1     16  3505
2   diseased     breast    E2     17  3293
3   diseased     breast    E3     18  1657
4   diseased     breast    E4     19  3258
5   diseased     breast    P1     24  3880
6   diseased     breast    P2     25  4491
7   diseased     breast    P3     26  4678
8   diseased dermatitis     1     01   517
9   diseased dermatitis     2     06   492
10  diseased dermatitis     5     08   628
11  diseased dermatitis     7     10   459
12  diseased  psoriasis Psor1     27   255
13  diseased  psoriasis Psor2     28   191
14  diseased  psoriasis Psor3     29   353</code></pre>
<div id="unintegrated-3" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Unintegrated</h2>
<p>UMAP layout and QC of unintegrated dataset.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/seurat-filtered-diseased.Rds&quot;</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s) <span class="sc">%&gt;%</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">FindVariableFeatures</span>() <span class="sc">%&gt;%</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ScaleData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunPCA</span>(<span class="at">verbose=</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunUMAP</span>(<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code></pre></div>
<div id="qc-7" class="section level3" number="5.1.1">
<h3><span class="header-section-number">5.1.1</span> QC</h3>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">VlnPlot</span>(s,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;nCount_RNA&quot;</span>,<span class="st">&quot;nFeature_RNA&quot;</span>,<span class="st">&quot;percent_mito&quot;</span>,<span class="st">&quot;percent_ribo&quot;</span>,<span class="st">&quot;df_rate&quot;</span>),<span class="at">pt.size=</span><span class="dv">0</span>,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>)<span class="sc">&amp;</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_report</span>()<span class="sc">&amp;</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>,</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x=</span><span class="fu">element_blank</span>())</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/ui-filtered-qc-violin.png&quot;</span>,p,<span class="at">height=</span><span class="dv">9</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>) <span class="sc">&amp;</span> <span class="fu">coord_fixed</span>()</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/ui-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/ui-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">6</span>)</span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/ui-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb63-35"><a href="#cb63-35" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/ui-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb63-36"><a href="#cb63-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-37"><a href="#cb63-37" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb63-38"><a href="#cb63-38" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/ui-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb63-39"><a href="#cb63-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-40"><a href="#cb63-40" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb63-41"><a href="#cb63-41" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/ui-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">8</span>)</span>
<span id="cb63-42"><a href="#cb63-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-43"><a href="#cb63-43" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>, <span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb63-44"><a href="#cb63-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb63-45"><a href="#cb63-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb63-46"><a href="#cb63-46" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/ui-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb63-47"><a href="#cb63-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-48"><a href="#cb63-48" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb63-49"><a href="#cb63-49" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/diseased/full/unintegrated/seurat-unintegrated.Rds&quot;</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/diseased/full/unintegrated/ui-umap-sample.png" /></p>
<p><b>Fig. </b> 53: <em>UMAP scatterplot of unintegrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/diseased/full/unintegrated/ui-umap-qc.png" /></p>
<p><b>Fig. </b> 54: <em>QC plots of unintegrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/unintegrated/ui-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 55: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/unintegrated/ui-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 56: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/unintegrated/ui-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 57: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/unintegrated/ui-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 58: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/unintegrated/ui-umap-known-markers.png" /></p>
<p><b>Fig. </b> 59: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="integration-3" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Integration</h2>
<p>Data is integrated across samples (individuals). Normalisation is carried out separately for each individual.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/seurat-unintegrated.Rds&quot;</span>),<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(s<span class="sc">$</span>sample)))</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>s.list <span class="ot">&lt;-</span> <span class="fu">SplitObject</span>(s,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(s.list)) {</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s.list[[i]],<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">normalization.method=</span><span class="st">&quot;LogNormalize&quot;</span>)</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(s.list[[i]], <span class="at">selection.method=</span><span class="st">&quot;vst&quot;</span>, <span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>s.features <span class="ot">&lt;-</span> <span class="fu">SelectIntegrationFeatures</span>(s.list,<span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>s.anchors <span class="ot">&lt;-</span> <span class="fu">FindIntegrationAnchors</span>(<span class="at">object.list=</span>s.list,<span class="at">anchor.features=</span>s.features)</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">IntegrateData</span>(<span class="at">anchorset=</span>s.anchors)</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(ss) <span class="ot">&lt;-</span> <span class="st">&quot;integrated&quot;</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(ss)</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(ss,<span class="at">verbose=</span>F,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(ss,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;Writing data&quot;</span>)</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/diseased/full/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
</div>
<div id="integrated-3" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Integrated</h2>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/full/integrated/seurat-integrated-separate.Rds&quot;</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(ss<span class="sc">$</span>condition,ss<span class="sc">$</span>study,ss<span class="sc">$</span>orig.ident,ss<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<p>Conditions, individual IDs (original and new), datasets and counts of cells.</p>
<pre><code>An object of class Seurat 
18181 features across 27657 samples within 2 assays 
Active assay: integrated (2000 features, 2000 variable features)
 1 other assay present: RNA
 2 dimensional reductions calculated: pca, umap


   condition      study   ind sample cells
1   diseased     breast    E1     16  3505
2   diseased     breast    E2     17  3293
3   diseased     breast    E3     18  1657
4   diseased     breast    E4     19  3258
5   diseased     breast    P1     24  3880
6   diseased     breast    P2     25  4491
7   diseased     breast    P3     26  4678
8   diseased dermatitis     1     01   517
9   diseased dermatitis     2     06   492
10  diseased dermatitis     5     08   628
11  diseased dermatitis     7     10   459
12  diseased  psoriasis Psor1     27   255
13  diseased  psoriasis Psor2     28   191
14  diseased  psoriasis Psor3     29   353</code></pre>
<div id="qc-8" class="section level3" number="5.3.1">
<h3><span class="header-section-number">5.3.1</span> QC</h3>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>)<span class="sc">&amp;</span><span class="fu">coord_fixed</span>()</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/integrated/is-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/integrated/is-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/integrated/is-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/integrated/is-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/integrated/is-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/integrated/is-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">5</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>,<span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/full/integrated/is-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/diseased/full/integrated/is-umap-sample.png" /></p>
<p><b>Fig. </b> 60: <em>UMAP scatterplot of integrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/diseased/full/integrated/is-umap-qc.png" /></p>
<p><b>Fig. </b> 61: <em>QC plots of integrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/integrated/is-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 62: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/integrated/is-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 63: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/integrated/is-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 64: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/integrated/is-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 65: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/integrated/is-umap-known-markers.png" /></p>
<p><b>Fig. </b> 66: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="clustering-3" class="section level2" number="5.4">
<h2><span class="header-section-number">5.4</span> Clustering</h2>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(ss,<span class="at">reduction=</span><span class="st">&quot;pca&quot;</span>,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(ss,<span class="at">resolution=</span><span class="fl">0.2</span>,<span class="at">random.seed=</span><span class="dv">100</span>)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>, <span class="fu">as.integer</span>(ss<span class="sc">$</span>seurat_clusters)))</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">factor</span>(ids,<span class="at">levels=</span><span class="fu">sort</span>(<span class="fu">unique</span>(ids)))</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ids) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(ss)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>ss[[<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids))))]] <span class="ot">&lt;-</span> ids</span></code></pre></div>
<div id="markers-3" class="section level3" number="5.4.1">
<h3><span class="header-section-number">5.4.1</span> Markers</h3>
<p>Marker genes are identified for each cluster group.</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write marker genes</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>cid <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids)))</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(ss) <span class="ot">&lt;-</span> ss[[]][,<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,cid)]</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">FindAllMarkers</span>(ss,</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">test.use=</span><span class="st">&quot;MAST&quot;</span>,<span class="at">only.pos=</span><span class="cn">TRUE</span>,<span class="at">min.pct=</span><span class="fl">0.25</span>,</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">logfc.threshold=</span><span class="fl">0.25</span>,<span class="at">max.cells.per.ident=</span><span class="dv">200</span>,</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">min.cells.group=</span><span class="dv">10</span>,<span class="at">random.seed=</span><span class="dv">100</span>,</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>   <span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;data&quot;</span>,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">latent.vars=</span><span class="fu">c</span>(<span class="st">&quot;nCount_RNA&quot;</span>,<span class="st">&quot;sample&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(p_val_adj<span class="sc">&lt;</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster,<span class="sc">-</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(temp,<span class="at">path=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/full/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>))</span></code></pre></div>
<p>Top 10 marker genes are visualised as dotplot and heatmap.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/full/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">n=</span><span class="dv">10</span>,<span class="at">order_by=</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;cluster_07&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/full/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-umap.png&quot;</span>),p,<span class="at">height=</span><span class="dv">7</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DotPlot</span>(ss,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene))<span class="sc">+</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>()<span class="sc">+</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_report</span>()<span class="sc">+</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;right&quot;</span>,</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.direction=</span><span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.title=</span><span class="fu">element_blank</span>())</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/full/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-dotplot.png&quot;</span>),p,<span class="at">height=</span><span class="dv">11</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(ss,<span class="at">downsample=</span><span class="dv">100</span>),<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene),<span class="at">assay=</span><span class="st">&quot;integrated&quot;</span>)<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/full/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-heatmap.png&quot;</span>),p,<span class="at">height=</span><span class="fu">nrow</span>(m1)<span class="sc">*</span><span class="fl">0.18</span>,<span class="at">width=</span><span class="dv">8</span>,<span class="at">limitsize=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/diseased/full/integrated/clustering/markers-clusters-07-umap.png" /></p>
<p><b>Fig. </b> 67: <em>UMAP showing clusters.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/integrated/clustering/markers-clusters-07-dotplot.png" /></p>
<p><b>Fig. </b> 68: <em>Dotplot of top marker genes.</em></p>
<p><img src="markdown_images/data/processed/diseased/full/integrated/clustering/markers-clusters-07-heatmap.png" /></p>
<p><b>Fig. </b> 69: <em>Heatmap of top marker genes.</em></p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/diseased/full/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>hf <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;data/processed/diseased/full/integrated/clustering/optimising/markers/&quot;</span>,<span class="st">&quot;.png&quot;</span>,<span class="at">full.names=</span>T)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(hf)</span></code></pre></div>
</div>
</div>
</div>
<div id="diseased-ad" class="section level1" number="6">
<h1><span class="header-section-number">6</span> Diseased-AD</h1>
<ul>
<li>Diseased AD samples:
<ul>
<li>Dataset 1.2 “Breast” sample IDs: E1, E2, E3, E4</li>
<li>Dataset 7.2 “Dermatitis” sample IDs: 1, 2, 5, 7</li>
</ul></li>
</ul>
<div id="unintegrated-4" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Unintegrated</h2>
<p>UMAP layout and QC of unintegrated dataset.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/seurat-filtered-diseased.Rds&quot;</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">subset</span>(s,<span class="at">subset=</span>orig.ident <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;E1&quot;</span>,<span class="st">&quot;E2&quot;</span>,<span class="st">&quot;E3&quot;</span>,<span class="st">&quot;E4&quot;</span>,<span class="st">&quot;1&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;5&quot;</span>,<span class="st">&quot;7&quot;</span>)),<span class="at">counts=</span><span class="cn">TRUE</span>,<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(<span class="fu">as.character</span>(s<span class="sc">$</span>sample))))</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>study))</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition))</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>sample))</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition,s<span class="sc">$</span>study,s<span class="sc">$</span>orig.ident,s<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s) <span class="sc">%&gt;%</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">FindVariableFeatures</span>() <span class="sc">%&gt;%</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ScaleData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunPCA</span>(<span class="at">verbose=</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunUMAP</span>(<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code></pre></div>
<pre><code>1     breast 11713
2 dermatitis  2096

1   01  517
2   06  492
3   08  628
4   10  459
5   16 3505
6   17 3293
7   18 1657
8   19 3258

  condition      study ind sample cells
1  diseased     breast  E1     16  3505
2  diseased     breast  E2     17  3293
3  diseased     breast  E3     18  1657
4  diseased     breast  E4     19  3258
5  diseased dermatitis   1     01   517
6  diseased dermatitis   2     06   492
7  diseased dermatitis   5     08   628
8  diseased dermatitis   7     10   459</code></pre>
<div id="qc-9" class="section level3" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> QC</h3>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>) <span class="sc">&amp;</span> <span class="fu">coord_fixed</span>()</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/unintegrated/ui-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/unintegrated/ui-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">6</span>)</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/unintegrated/ui-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/unintegrated/ui-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/unintegrated/ui-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/unintegrated/ui-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">8</span>)</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>, <span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/unintegrated/ui-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/diseased/ad/unintegrated/seurat-unintegrated.Rds&quot;</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/diseased/ad/unintegrated/ui-umap-sample.png" /></p>
<p><b>Fig. </b> 70: <em>UMAP scatterplot of unintegrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/unintegrated/ui-umap-qc.png" /></p>
<p><b>Fig. </b> 71: <em>QC plots of unintegrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/unintegrated/ui-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 72: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/unintegrated/ui-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 73: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/unintegrated/ui-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 74: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/unintegrated/ui-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 75: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/unintegrated/ui-umap-known-markers.png" /></p>
<p><b>Fig. </b> 76: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="integration-4" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Integration</h2>
<p>Full diseased dataset was subsetted. Data is integrated across samples (individuals). Normalisation is carried out separately for each individual.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/seurat-unintegrated.Rds&quot;</span>)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">subset</span>(s,<span class="at">subset=</span>orig.ident <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;E1&quot;</span>,<span class="st">&quot;E2&quot;</span>,<span class="st">&quot;E3&quot;</span>,<span class="st">&quot;E4&quot;</span>,<span class="st">&quot;1&quot;</span>,<span class="st">&quot;2&quot;</span>,<span class="st">&quot;5&quot;</span>,<span class="st">&quot;7&quot;</span>)),<span class="at">counts=</span><span class="cn">TRUE</span>,<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(s<span class="sc">$</span>sample)))</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>s.list <span class="ot">&lt;-</span> <span class="fu">SplitObject</span>(s,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(s.list)) {</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s.list[[i]],<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">normalization.method=</span><span class="st">&quot;LogNormalize&quot;</span>)</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(s.list[[i]], <span class="at">selection.method=</span><span class="st">&quot;vst&quot;</span>, <span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>s.features <span class="ot">&lt;-</span> <span class="fu">SelectIntegrationFeatures</span>(s.list,<span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>s.anchors <span class="ot">&lt;-</span> <span class="fu">FindIntegrationAnchors</span>(<span class="at">object.list=</span>s.list,<span class="at">anchor.features=</span>s.features)</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">IntegrateData</span>(<span class="at">anchorset=</span>s.anchors)</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(ss) <span class="ot">&lt;-</span> <span class="st">&quot;integrated&quot;</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(ss)</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(ss,<span class="at">verbose=</span>F,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(ss,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;Writing data&quot;</span>)</span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/diseased/ad/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
</div>
<div id="integrated-4" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> Integrated</h2>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/seurat-integrated-separate.Rds&quot;</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(ss<span class="sc">$</span>condition,ss<span class="sc">$</span>study,ss<span class="sc">$</span>orig.ident,ss<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<p>Conditions, individual IDs (original and new), datasets and counts of cells.</p>
<pre><code>An object of class Seurat 
18181 features across 13809 samples within 2 assays 
Active assay: integrated (2000 features, 2000 variable features)
 1 other assay present: RNA
 2 dimensional reductions calculated: pca, umap

  condition      study ind sample cells
1  diseased     breast  E1     16  3505
2  diseased     breast  E2     17  3293
3  diseased     breast  E3     18  1657
4  diseased     breast  E4     19  3258
5  diseased dermatitis   1     01   517
6  diseased dermatitis   2     06   492
7  diseased dermatitis   5     08   628
8  diseased dermatitis   7     10   459</code></pre>
<div id="qc-10" class="section level3" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> QC</h3>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>)<span class="sc">&amp;</span><span class="fu">coord_fixed</span>()</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/is-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/is-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/is-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/is-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/is-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/is-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">5</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>,<span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/is-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/diseased/ad/integrated/is-umap-sample.png" /></p>
<p><b>Fig. </b> 77: <em>UMAP scatterplot of integrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/integrated/is-umap-qc.png" /></p>
<p><b>Fig. </b> 78: <em>QC plots of integrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/integrated/is-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 79: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/integrated/is-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 80: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/integrated/is-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 81: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/integrated/is-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 82: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/integrated/is-umap-known-markers.png" /></p>
<p><b>Fig. </b> 83: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="clustering-4" class="section level2" number="6.4">
<h2><span class="header-section-number">6.4</span> Clustering</h2>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(ss,<span class="at">reduction=</span><span class="st">&quot;pca&quot;</span>,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(ss,<span class="at">resolution=</span><span class="fl">0.2</span>,<span class="at">random.seed=</span><span class="dv">100</span>)</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>, <span class="fu">as.integer</span>(ss<span class="sc">$</span>seurat_clusters)))</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">factor</span>(ids,<span class="at">levels=</span><span class="fu">sort</span>(<span class="fu">unique</span>(ids)))</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ids) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(ss)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>ss[[<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids))))]] <span class="ot">&lt;-</span> ids</span></code></pre></div>
<div id="markers-4" class="section level3" number="6.4.1">
<h3><span class="header-section-number">6.4.1</span> Markers</h3>
<p>Marker genes are identified for each cluster group.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write marker genes</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>cid <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids)))</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(ss) <span class="ot">&lt;-</span> ss[[]][,<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,cid)]</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">FindAllMarkers</span>(ss,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">test.use=</span><span class="st">&quot;MAST&quot;</span>,<span class="at">only.pos=</span><span class="cn">TRUE</span>,<span class="at">min.pct=</span><span class="fl">0.25</span>,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">logfc.threshold=</span><span class="fl">0.25</span>,<span class="at">max.cells.per.ident=</span><span class="dv">200</span>,</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">min.cells.group=</span><span class="dv">10</span>,<span class="at">random.seed=</span><span class="dv">100</span>,</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>   <span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;data&quot;</span>,</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">latent.vars=</span><span class="fu">c</span>(<span class="st">&quot;nCount_RNA&quot;</span>,<span class="st">&quot;sample&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(p_val_adj<span class="sc">&lt;</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster,<span class="sc">-</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(temp,<span class="at">path=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>))</span></code></pre></div>
<p>Top 10 marker genes are visualised as dotplot and heatmap.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">n=</span><span class="dv">10</span>,<span class="at">order_by=</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;cluster_08&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-umap.png&quot;</span>),p,<span class="at">height=</span><span class="dv">7</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DotPlot</span>(ss,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene))<span class="sc">+</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>()<span class="sc">+</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_report</span>()<span class="sc">+</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;right&quot;</span>,</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.direction=</span><span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.title=</span><span class="fu">element_blank</span>())</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-dotplot.png&quot;</span>),p,<span class="at">height=</span><span class="dv">11</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(ss,<span class="at">downsample=</span><span class="dv">100</span>),<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene),<span class="at">assay=</span><span class="st">&quot;integrated&quot;</span>)<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-heatmap.png&quot;</span>),p,<span class="at">height=</span><span class="fu">nrow</span>(m1)<span class="sc">*</span><span class="fl">0.18</span>,<span class="at">width=</span><span class="dv">8</span>,<span class="at">limitsize=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/diseased/ad/integrated/clustering/markers-clusters-08-umap.png" /></p>
<p><b>Fig. </b> 84: <em>UMAP showing clusters.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/integrated/clustering/markers-clusters-08-dotplot.png" /></p>
<p><b>Fig. </b> 85: <em>Dotplot of top marker genes.</em></p>
<p><img src="markdown_images/data/processed/diseased/ad/integrated/clustering/markers-clusters-08-heatmap.png" /></p>
<p><b>Fig. </b> 86: <em>Heatmap of top marker genes.</em></p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/diseased/ad/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>hf <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;data/processed/diseased/ad/integrated/clustering/optimising/markers/&quot;</span>,<span class="st">&quot;.png&quot;</span>,<span class="at">full.names=</span>T)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(hf)</span></code></pre></div>
<hr />
</div>
</div>
</div>
<div id="diseased-p" class="section level1" number="7">
<h1><span class="header-section-number">7</span> Diseased-P</h1>
<ul>
<li>Diseased P samples:
<ul>
<li>Dataset 1.2 “Breast” sample IDs: P1, P2, P3</li>
<li>Dataset 6.2 “Psoriasis” sample IDs: Psor1, Psor2, Psor3</li>
</ul></li>
</ul>
<div id="unintegrated-5" class="section level2" number="7.1">
<h2><span class="header-section-number">7.1</span> Unintegrated</h2>
<p>UMAP layout and QC of unintegrated dataset.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/seurat-filtered-diseased.Rds&quot;</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">subset</span>(s,<span class="at">subset=</span>orig.ident <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;P1&quot;</span>,<span class="st">&quot;P2&quot;</span>,<span class="st">&quot;P3&quot;</span>,<span class="st">&quot;E4&quot;</span>,<span class="st">&quot;Psor1&quot;</span>,<span class="st">&quot;Psor2&quot;</span>,<span class="st">&quot;Psor3&quot;</span>)),<span class="at">counts=</span><span class="cn">TRUE</span>,<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(<span class="fu">as.character</span>(s<span class="sc">$</span>sample))))</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>study))</span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition))</span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>sample))</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition,s<span class="sc">$</span>study,s<span class="sc">$</span>orig.ident,s<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s) <span class="sc">%&gt;%</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">FindVariableFeatures</span>() <span class="sc">%&gt;%</span></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ScaleData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunPCA</span>(<span class="at">verbose=</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunUMAP</span>(<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code></pre></div>
<pre><code>1    breast 16307
2 psoriasis   799

1   19 3258
2   24 3880
3   25 4491
4   26 4678
5   27  255
6   28  191
7   29  353

  condition     study   ind sample cells
1  diseased    breast    E4     19  3258
2  diseased    breast    P1     24  3880
3  diseased    breast    P2     25  4491
4  diseased    breast    P3     26  4678
5  diseased psoriasis Psor1     27   255
6  diseased psoriasis Psor2     28   191
7  diseased psoriasis Psor3     29   353</code></pre>
<div id="qc-11" class="section level3" number="7.1.1">
<h3><span class="header-section-number">7.1.1</span> QC</h3>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>) <span class="sc">&amp;</span> <span class="fu">coord_fixed</span>()</span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/unintegrated/ui-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/unintegrated/ui-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">6</span>)</span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/unintegrated/ui-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/unintegrated/ui-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/unintegrated/ui-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/unintegrated/ui-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">8</span>)</span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>, <span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb87-39"><a href="#cb87-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/unintegrated/ui-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb87-40"><a href="#cb87-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-41"><a href="#cb87-41" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb87-42"><a href="#cb87-42" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/diseased/p/unintegrated/seurat-unintegrated.Rds&quot;</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/diseased/p/unintegrated/ui-umap-sample.png" /></p>
<p><b>Fig. </b> 87: <em>UMAP scatterplot of unintegrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/diseased/p/unintegrated/ui-umap-qc.png" /></p>
<p><b>Fig. </b> 88: <em>QC plots of unintegrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/unintegrated/ui-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 89: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/unintegrated/ui-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 90: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/unintegrated/ui-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 91: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/unintegrated/ui-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 92: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/unintegrated/ui-umap-known-markers.png" /></p>
<p><b>Fig. </b> 93: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="integration-5" class="section level2" number="7.2">
<h2><span class="header-section-number">7.2</span> Integration</h2>
<p>Full diseased dataset was subsetted. Data is integrated across samples (individuals). Normalisation is carried out separately for each individual.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/full/unintegrated/seurat-unintegrated.Rds&quot;</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">subset</span>(s,<span class="at">subset=</span>orig.ident <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;P1&quot;</span>,<span class="st">&quot;P2&quot;</span>,<span class="st">&quot;P3&quot;</span>,<span class="st">&quot;E4&quot;</span>,<span class="st">&quot;Psor1&quot;</span>,<span class="st">&quot;Psor2&quot;</span>,<span class="st">&quot;Psor3&quot;</span>)),<span class="at">counts=</span><span class="cn">TRUE</span>,<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(s<span class="sc">$</span>sample)))</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>s.list <span class="ot">&lt;-</span> <span class="fu">SplitObject</span>(s,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(s.list)) {</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s.list[[i]],<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">normalization.method=</span><span class="st">&quot;LogNormalize&quot;</span>)</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(s.list[[i]], <span class="at">selection.method=</span><span class="st">&quot;vst&quot;</span>, <span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>s.features <span class="ot">&lt;-</span> <span class="fu">SelectIntegrationFeatures</span>(s.list,<span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>s.anchors <span class="ot">&lt;-</span> <span class="fu">FindIntegrationAnchors</span>(<span class="at">object.list=</span>s.list,<span class="at">anchor.features=</span>s.features)</span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">IntegrateData</span>(<span class="at">anchorset=</span>s.anchors)</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(ss) <span class="ot">&lt;-</span> <span class="st">&quot;integrated&quot;</span></span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(ss)</span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(ss,<span class="at">verbose=</span>F,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(ss,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;Writing data&quot;</span>)</span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/diseased/p/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
</div>
<div id="integrated-5" class="section level2" number="7.3">
<h2><span class="header-section-number">7.3</span> Integrated</h2>
<div class="sourceCode" id="cb89"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/diseased/p/integrated/seurat-integrated-separate.Rds&quot;</span>)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(ss<span class="sc">$</span>condition,ss<span class="sc">$</span>study,ss<span class="sc">$</span>orig.ident,ss<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<p>Conditions, individual IDs (original and new), datasets and counts of cells.</p>
<pre><code>An object of class Seurat 
18181 features across 17106 samples within 2 assays 
Active assay: integrated (2000 features, 2000 variable features)
 1 other assay present: RNA
 2 dimensional reductions calculated: pca, umap

  condition     study   ind sample cells
1  diseased    breast    E4     19  3258
2  diseased    breast    P1     24  3880
3  diseased    breast    P2     25  4491
4  diseased    breast    P3     26  4678
5  diseased psoriasis Psor1     27   255
6  diseased psoriasis Psor2     28   191
7  diseased psoriasis Psor3     29   353</code></pre>
<div id="qc-12" class="section level3" number="7.3.1">
<h3><span class="header-section-number">7.3.1</span> QC</h3>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>)<span class="sc">&amp;</span><span class="fu">coord_fixed</span>()</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/integrated/is-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/integrated/is-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/integrated/is-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/integrated/is-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/integrated/is-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/integrated/is-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">5</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>,<span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/diseased/p/integrated/is-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/diseased/p/integrated/is-umap-sample.png" /></p>
<p><b>Fig. </b> 94: <em>UMAP scatterplot of integrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/diseased/p/integrated/is-umap-qc.png" /></p>
<p><b>Fig. </b> 95: <em>QC plots of integrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/integrated/is-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 96: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/integrated/is-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 97: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/integrated/is-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 98: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/integrated/is-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 99: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/integrated/is-umap-known-markers.png" /></p>
<p><b>Fig. </b> 100: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="clustering-5" class="section level2" number="7.4">
<h2><span class="header-section-number">7.4</span> Clustering</h2>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(ss,<span class="at">reduction=</span><span class="st">&quot;pca&quot;</span>,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(ss,<span class="at">resolution=</span><span class="fl">0.2</span>,<span class="at">random.seed=</span><span class="dv">100</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>, <span class="fu">as.integer</span>(ss<span class="sc">$</span>seurat_clusters)))</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">factor</span>(ids,<span class="at">levels=</span><span class="fu">sort</span>(<span class="fu">unique</span>(ids)))</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ids) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(ss)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>ss[[<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids))))]] <span class="ot">&lt;-</span> ids</span></code></pre></div>
<div id="markers-5" class="section level3" number="7.4.1">
<h3><span class="header-section-number">7.4.1</span> Markers</h3>
<p>Marker genes are identified for each cluster group.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write marker genes</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>cid <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids)))</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(ss) <span class="ot">&lt;-</span> ss[[]][,<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,cid)]</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">FindAllMarkers</span>(ss,</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">test.use=</span><span class="st">&quot;MAST&quot;</span>,<span class="at">only.pos=</span><span class="cn">TRUE</span>,<span class="at">min.pct=</span><span class="fl">0.25</span>,</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">logfc.threshold=</span><span class="fl">0.25</span>,<span class="at">max.cells.per.ident=</span><span class="dv">200</span>,</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">min.cells.group=</span><span class="dv">10</span>,<span class="at">random.seed=</span><span class="dv">100</span>,</span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>   <span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;data&quot;</span>,</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">latent.vars=</span><span class="fu">c</span>(<span class="st">&quot;nCount_RNA&quot;</span>,<span class="st">&quot;sample&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(p_val_adj<span class="sc">&lt;</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster,<span class="sc">-</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(temp,<span class="at">path=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/p/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>))</span></code></pre></div>
<p>Top 10 marker genes are visualised as dotplot and heatmap.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/p/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">n=</span><span class="dv">10</span>,<span class="at">order_by=</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;cluster_08&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/p/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-umap.png&quot;</span>),p,<span class="at">height=</span><span class="dv">7</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DotPlot</span>(ss,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene))<span class="sc">+</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>()<span class="sc">+</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_report</span>()<span class="sc">+</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;right&quot;</span>,</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.direction=</span><span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.title=</span><span class="fu">element_blank</span>())</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/p/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-dotplot.png&quot;</span>),p,<span class="at">height=</span><span class="dv">11</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(ss,<span class="at">downsample=</span><span class="dv">100</span>),<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene),<span class="at">assay=</span><span class="st">&quot;integrated&quot;</span>)<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/diseased/p/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-heatmap.png&quot;</span>),p,<span class="at">height=</span><span class="fu">nrow</span>(m1)<span class="sc">*</span><span class="fl">0.18</span>,<span class="at">width=</span><span class="dv">8</span>,<span class="at">limitsize=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/diseased/p/integrated/clustering/markers-clusters-08-umap.png" /></p>
<p><b>Fig. </b> 101: <em>UMAP showing clusters.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/integrated/clustering/markers-clusters-08-dotplot.png" /></p>
<p><b>Fig. </b> 102: <em>Dotplot of top marker genes.</em></p>
<p><img src="markdown_images/data/processed/diseased/p/integrated/clustering/markers-clusters-08-heatmap.png" /></p>
<p><b>Fig. </b> 103: <em>Heatmap of top marker genes.</em></p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/diseased/p/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>hf <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;data/processed/diseased/p/integrated/clustering/optimising/markers/&quot;</span>,<span class="st">&quot;.png&quot;</span>,<span class="at">full.names=</span>T)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(hf)</span></code></pre></div>
</div>
</div>
</div>
<div id="healthy" class="section level1" number="8">
<h1><span class="header-section-number">8</span> Healthy</h1>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy-diseased/full/seurat-filtered.Rds&quot;</span>)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">subset</span>(s,<span class="at">subset=</span>condition<span class="sc">==</span><span class="st">&quot;healthy&quot;</span>),<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(<span class="fu">as.character</span>(s<span class="sc">$</span>sample))))</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>study))</span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition))</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>sample))</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(s<span class="sc">$</span>condition,s<span class="sc">$</span>study,s<span class="sc">$</span>orig.ident,s<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<pre><code>An object of class Seurat 
16181 features across 46445 samples within 1 assay 
Active assay: RNA (16181 features, 0 variable features)

1      aging  1761
2     breast 11904
3 dermatitis  6095
4  psoriasis   308
5   vascular 26377

1    02   376
2    03  1022
3    04   132
4    05   387
5    07  1150
6    09  1322
7    12  1706
8    15   308
9    20   305
10   21   569
11   22 13232
12   23 12271
13   30  4834
14   31   183
15   32  4523
16   33   319
17   34  2547
18   35   611
19   36   246
20   37   402

   condition      study   ind sample cells
1    healthy      aging    S1     31   183
2    healthy      aging    S2     33   319
3    healthy      aging    S3     35   611
4    healthy      aging    S4     36   246
5    healthy      aging    S5     37   402
6    healthy     breast    s1     30  4834
7    healthy     breast    s2     32  4523
8    healthy     breast    s3     34  2547
9    healthy dermatitis    10     02   376
10   healthy dermatitis    12     03  1022
11   healthy dermatitis    13     04   132
12   healthy dermatitis    17     05   387
13   healthy dermatitis     4     07  1150
14   healthy dermatitis     6     09  1322
15   healthy dermatitis     9     12  1706
16   healthy  psoriasis Ctrl3     15   308
17   healthy   vascular  EC_1     20   305
18   healthy   vascular  EC_2     21   569
19   healthy   vascular  EC_3     22 13232
20   healthy   vascular  EC_4     23 12271</code></pre>
<div id="unintegrated-6" class="section level2" number="8.1">
<h2><span class="header-section-number">8.1</span> Unintegrated</h2>
<p>UMAP layout and QC of unintegrated dataset.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s) <span class="sc">%&gt;%</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>      <span class="fu">FindVariableFeatures</span>() <span class="sc">%&gt;%</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ScaleData</span>() <span class="sc">%&gt;%</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunPCA</span>(<span class="at">verbose=</span>F) <span class="sc">%&gt;%</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">RunUMAP</span>(<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span></code></pre></div>
<div id="qc-13" class="section level3" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> QC</h3>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">VlnPlot</span>(s,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;nCount_RNA&quot;</span>,<span class="st">&quot;nFeature_RNA&quot;</span>,<span class="st">&quot;percent_mito&quot;</span>,<span class="st">&quot;percent_ribo&quot;</span>,<span class="st">&quot;df_rate&quot;</span>),<span class="at">pt.size=</span><span class="dv">0</span>,<span class="at">ncol=</span><span class="dv">1</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>)<span class="sc">&amp;</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_report</span>()<span class="sc">&amp;</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;none&quot;</span>,</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x=</span><span class="fu">element_blank</span>())</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/unintegrated/ui-filtered-qc-violin.png&quot;</span>,p,<span class="at">height=</span><span class="dv">9</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">16</span>)</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">12</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;status&quot;</span>)</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">13</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;site&quot;</span>)</span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">14</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;tissue&quot;</span>)</span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">15</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sex&quot;</span>)</span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">16</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;age&quot;</span>)</span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">4</span>) <span class="sc">&amp;</span> <span class="fu">coord_fixed</span>()</span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/unintegrated/ui-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">22</span>)</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/unintegrated/ui-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">6</span>)</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/unintegrated/ui-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/unintegrated/ui-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/unintegrated/ui-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">14</span>)</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(s,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/unintegrated/ui-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">8</span>)</span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(s,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>, <span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/unintegrated/ui-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-48"><a href="#cb100-48" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb100-49"><a href="#cb100-49" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(s,<span class="st">&quot;data/processed/healthy/unintegrated/seurat-unintegrated.Rds&quot;</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy/unintegrated/ui-umap-sample.png" /></p>
<p><b>Fig. </b> 104: <em>UMAP scatterplot of unintegrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/healthy/unintegrated/ui-umap-qc.png" /></p>
<p><b>Fig. </b> 105: <em>QC plots of unintegrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/healthy/unintegrated/ui-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 106: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy/unintegrated/ui-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 107: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy/unintegrated/ui-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 108: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy/unintegrated/ui-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 109: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/healthy/unintegrated/ui-umap-known-markers.png" /></p>
<p><b>Fig. </b> 110: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="integration-6" class="section level2" number="8.2">
<h2><span class="header-section-number">8.2</span> Integration</h2>
<p>Data is integrated across samples (individuals). Normalisation is carried out separately for each individual.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">DietSeurat</span>(<span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy/unintegrated/seurat-unintegrated.Rds&quot;</span>),<span class="at">assays=</span><span class="st">&quot;RNA&quot;</span>)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">factor</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">as.integer</span>(s<span class="sc">$</span>sample)))</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(s) <span class="ot">&lt;-</span> s<span class="sc">$</span>sample</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nCount_RNA <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)))</span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>s<span class="sc">$</span>nFeature_RNA <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">GetAssayData</span>(s)<span class="sc">&gt;</span><span class="dv">0</span>)</span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>s.list <span class="ot">&lt;-</span> <span class="fu">SplitObject</span>(s,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(s.list)) {</span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(s.list[[i]],<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">normalization.method=</span><span class="st">&quot;LogNormalize&quot;</span>)</span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a>    s.list[[i]] <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(s.list[[i]], <span class="at">selection.method=</span><span class="st">&quot;vst&quot;</span>, <span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>s.features <span class="ot">&lt;-</span> <span class="fu">SelectIntegrationFeatures</span>(s.list,<span class="at">nfeatures=</span><span class="dv">2000</span>)</span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a>s.anchors <span class="ot">&lt;-</span> <span class="fu">FindIntegrationAnchors</span>(<span class="at">object.list=</span>s.list,<span class="at">anchor.features=</span>s.features)</span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">IntegrateData</span>(<span class="at">anchorset=</span>s.anchors)</span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a><span class="fu">DefaultAssay</span>(ss) <span class="ot">&lt;-</span> <span class="st">&quot;integrated&quot;</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(ss)</span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(ss,<span class="at">verbose=</span>F,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(ss,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>,<span class="at">seed.use=</span><span class="dv">100</span>)</span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;Writing data&quot;</span>)</span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/healthy/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
</div>
<div id="integrated-6" class="section level2" number="8.3">
<h2><span class="header-section-number">8.3</span> Integrated</h2>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;data/processed/healthy/integrated/seurat-integrated-separate.Rds&quot;</span>)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.frame</span>(<span class="fu">table</span>(ss<span class="sc">$</span>condition,ss<span class="sc">$</span>study,ss<span class="sc">$</span>orig.ident,ss<span class="sc">$</span>sample)) <span class="sc">%&gt;%</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Freq<span class="sc">!=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">&quot;condition&quot;</span>,<span class="st">&quot;study&quot;</span>,<span class="st">&quot;ind&quot;</span>,<span class="st">&quot;sample&quot;</span>,<span class="st">&quot;cells&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(condition,study,ind)</span></code></pre></div>
<p>Conditions, individual IDs (original and new), datasets and counts of cells.</p>
<pre><code>An object of class Seurat 
18181 features across 46445 samples within 2 assays 
Active assay: integrated (2000 features, 2000 variable features)
 1 other assay present: RNA
 2 dimensional reductions calculated: pca, umap

   condition      study   ind sample cells
1    healthy      aging    S1     14   183
2    healthy      aging    S2     16   319
3    healthy      aging    S3     18   611
4    healthy      aging    S4     19   246
5    healthy      aging    S5     20   402
6    healthy     breast    s1     13  4834
7    healthy     breast    s2     15  4523
8    healthy     breast    s3     17  2547
9    healthy dermatitis    10     01   376
10   healthy dermatitis    12     02  1022
11   healthy dermatitis    13     03   132
12   healthy dermatitis    17     04   387
13   healthy dermatitis     4     05  1150
14   healthy dermatitis     6     06  1322
15   healthy dermatitis     9     07  1706
16   healthy  psoriasis Ctrl3     08   308
17   healthy   vascular  EC_1     09   305
18   healthy   vascular  EC_2     10   569
19   healthy   vascular  EC_3     11 13232
20   healthy   vascular  EC_4     12 12271</code></pre>
<div id="qc-14" class="section level3" number="8.3.1">
<h3><span class="header-section-number">8.3.1</span> QC</h3>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;list&quot;</span>,<span class="at">length=</span><span class="dv">11</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;orig.ident&quot;</span>)</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">3</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>)</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">4</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">5</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nCount_RNA&quot;</span>)</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">6</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;nFeature_RNA&quot;</span>)</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">7</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_mito&quot;</span>)</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">8</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;percent_ribo&quot;</span>)</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">9</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;Phase&quot;</span>)</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">10</span>]] <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">order=</span><span class="fu">c</span>(<span class="st">&quot;Doublet&quot;</span>,<span class="st">&quot;Singlet&quot;</span>))</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>p[[<span class="dv">11</span>]] <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="st">&quot;df_rate&quot;</span>)</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(p,<span class="at">nrow=</span><span class="dv">4</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">&amp;</span><span class="fu">coord_fixed</span>()</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/integrated/is-umap-qc.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">20</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;sample&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/integrated/is-umap-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">6</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/integrated/is-umap-condition-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/integrated/is-umap-study-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;df_class&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;sample&quot;</span>,<span class="at">ncol=</span><span class="dv">6</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/integrated/is-umap-doublet-split-sample.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">15</span>,<span class="at">width=</span><span class="dv">18</span>)</span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;condition&quot;</span>,<span class="at">split.by=</span><span class="st">&quot;study&quot;</span>,<span class="at">ncol=</span><span class="dv">3</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()</span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/integrated/is-umap-condition-split-study.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">5</span>,<span class="at">width=</span><span class="dv">9</span>)</span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(ss,<span class="at">features=</span><span class="fu">c</span>(<span class="st">&quot;Pecam1&quot;</span>,<span class="st">&quot;Prox1&quot;</span>,<span class="st">&quot;Kdr&quot;</span>,<span class="st">&quot;Cdh5&quot;</span>,<span class="st">&quot;Cd34&quot;</span>),<span class="at">order=</span>T)<span class="sc">&amp;</span></span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>()<span class="sc">&amp;</span></span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>()</span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">&quot;data/processed/healthy/integrated/is-umap-known-markers.png&quot;</span>,p1,<span class="at">height=</span><span class="dv">12</span>,<span class="at">width=</span><span class="dv">9</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy/integrated/is-umap-sample.png" /></p>
<p><b>Fig. </b> 111: <em>UMAP scatterplot of integrated data showing samples (individuals).</em></p>
<p><img src="markdown_images/data/processed/healthy/integrated/is-umap-qc.png" /></p>
<p><b>Fig. </b> 112: <em>QC plots of integrated data. UMAP scatterplot with cells coloured by various metadata variables. Some variables (status, site, tissue, sex, age, disease) are only present in the <strong>breast</strong> dataset and other cells show up as NA.</em></p>
<p><img src="markdown_images/data/processed/healthy/integrated/is-umap-condition-split-sample.png" /></p>
<p><b>Fig. </b> 113: <em>UMAP scatterplot of unintegrated data coloured by condition and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy/integrated/is-umap-study-split-sample.png" /></p>
<p><b>Fig. </b> 114: <em>UMAP scatterplot of unintegrated data coloured by study and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy/integrated/is-umap-doublet-split-sample.png" /></p>
<p><b>Fig. </b> 115: <em>UMAP scatterplot of unintegrated data coloured by doublet class and split by sample.</em></p>
<p><img src="markdown_images/data/processed/healthy/integrated/is-umap-condition-split-study.png" /></p>
<p><b>Fig. </b> 116: <em>UMAP scatterplot of unintegrated data coloured by condition and split by study.</em></p>
<p><img src="markdown_images/data/processed/healthy/integrated/is-umap-known-markers.png" /></p>
<p><b>Fig. </b> 117: <em>UMAP scatterplot showing expression of known marker genes.</em></p>
</div>
</div>
<div id="clustering-6" class="section level2" number="8.4">
<h2><span class="header-section-number">8.4</span> Clustering</h2>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(ss,<span class="at">reduction=</span><span class="st">&quot;pca&quot;</span>,<span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>)</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>ss <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(ss,<span class="at">resolution=</span><span class="fl">0.2</span>,<span class="at">random.seed=</span><span class="dv">100</span>)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>, <span class="fu">as.integer</span>(ss<span class="sc">$</span>seurat_clusters)))</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>ids <span class="ot">&lt;-</span> <span class="fu">factor</span>(ids,<span class="at">levels=</span><span class="fu">sort</span>(<span class="fu">unique</span>(ids)))</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ids) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(ss)</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>ss[[<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,<span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids))))]] <span class="ot">&lt;-</span> ids</span></code></pre></div>
<div id="markers-6" class="section level3" number="8.4.1">
<h3><span class="header-section-number">8.4.1</span> Markers</h3>
<p>Marker genes are identified for each cluster group.</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write marker genes</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>cid <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;%02.0f&quot;</span>,<span class="fu">length</span>(<span class="fu">levels</span>(ids)))</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="fu">Idents</span>(ss) <span class="ot">&lt;-</span> ss[[]][,<span class="fu">paste0</span>(<span class="st">&quot;cluster_&quot;</span>,cid)]</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">FindAllMarkers</span>(ss,</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">test.use=</span><span class="st">&quot;MAST&quot;</span>,<span class="at">only.pos=</span><span class="cn">TRUE</span>,<span class="at">min.pct=</span><span class="fl">0.25</span>,</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">logfc.threshold=</span><span class="fl">0.25</span>,<span class="at">max.cells.per.ident=</span><span class="dv">200</span>,</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">min.cells.group=</span><span class="dv">10</span>,<span class="at">random.seed=</span><span class="dv">100</span>,</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>   <span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">slot=</span><span class="st">&quot;data&quot;</span>,</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">latent.vars=</span><span class="fu">c</span>(<span class="st">&quot;nCount_RNA&quot;</span>,<span class="st">&quot;sample&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(p_val_adj<span class="sc">&lt;</span><span class="fl">0.05</span>) <span class="sc">%&gt;%</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(cluster,<span class="sc">-</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>writexl<span class="sc">::</span><span class="fu">write_xlsx</span>(temp,<span class="at">path=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>))</span></code></pre></div>
<p>Top 10 marker genes are visualised as dotplot and heatmap.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create heatmaps</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> readxl<span class="sc">::</span><span class="fu">read_xlsx</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;.xlsx&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">n=</span><span class="dv">10</span>,<span class="at">order_by=</span><span class="fu">abs</span>(avg_log2FC))</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">UMAPPlot</span>(ss,<span class="at">group.by=</span><span class="st">&quot;cluster_08&quot;</span>)<span class="sc">+</span><span class="fu">coord_fixed</span>()<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-umap.png&quot;</span>),p,<span class="at">height=</span><span class="dv">7</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DotPlot</span>(ss,<span class="at">assay=</span><span class="st">&quot;RNA&quot;</span>,<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene))<span class="sc">+</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_flip</span>()<span class="sc">+</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_report</span>()<span class="sc">+</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">&quot;right&quot;</span>,</span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.direction=</span><span class="st">&quot;vertical&quot;</span>,</span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">axis.title=</span><span class="fu">element_blank</span>())</span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-dotplot.png&quot;</span>),p,<span class="at">height=</span><span class="dv">11</span>,<span class="at">width=</span><span class="dv">7</span>)</span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">DoHeatmap</span>(<span class="fu">subset</span>(ss,<span class="at">downsample=</span><span class="dv">100</span>),<span class="at">features=</span><span class="fu">unique</span>(m1<span class="sc">$</span>gene),<span class="at">assay=</span><span class="st">&quot;integrated&quot;</span>)<span class="sc">+</span><span class="fu">theme_report</span>()</span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">filename=</span><span class="fu">paste0</span>(<span class="st">&quot;data/processed/healthy/integrated/clustering/markers-clusters-&quot;</span>,cid,<span class="st">&quot;-heatmap.png&quot;</span>),p,<span class="at">height=</span><span class="fu">nrow</span>(m1)<span class="sc">*</span><span class="fl">0.18</span>,<span class="at">width=</span><span class="dv">8</span>,<span class="at">limitsize=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="markdown_images/data/processed/healthy/integrated/clustering/markers-clusters-08-umap.png" /></p>
<p><b>Fig. </b> 118: <em>UMAP showing clusters.</em></p>
<p><img src="markdown_images/data/processed/healthy/integrated/clustering/markers-clusters-08-dotplot.png" /></p>
<p><b>Fig. </b> 119: <em>Dotplot of top marker genes.</em></p>
<p><img src="markdown_images/data/processed/healthy/integrated/clustering/markers-clusters-08-heatmap.png" /></p>
<p><b>Fig. </b> 120: <em>Heatmap of top marker genes.</em></p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(ss,<span class="st">&quot;data/processed/healthy/integrated/seurat-integrated-separate.Rds&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>hf <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;data/processed/healthy/integrated/clustering/optimising/markers/&quot;</span>,<span class="st">&quot;.png&quot;</span>,<span class="at">full.names=</span>T)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(hf)</span></code></pre></div>
<hr />
<p>End of document.</p>
</div>
</div>
</div>


<footer class="footer">
  <div class="container">
    <div class="footer-flex">

    <div class="footer-left">
    <span class="small">
    <b>2022</b> • <a href="https://nbis.se/">NBIS</a> • <a href="https://www.scilifelab.se/">SciLifeLab</a>
    </span>
    </div>

    <div class="footer-right">
      <span class="footericon" style="padding-right:4px; padding-left:4px">
        <a href="https://nbis.se/">
          <svg style="height:0.8em;top:.04em;position:relative;fill:#bdbdbd;" viewBox="0 0 496 512"><path d="M248 8C111.03 8 0 119.03 0 256s111.03 248 248 248 248-111.03 248-248S384.97 8 248 8zm82.29 357.6c-3.9 3.88-7.99 7.95-11.31 11.28-2.99 3-5.1 6.7-6.17 10.71-1.51 5.66-2.73 11.38-4.77 16.87l-17.39 46.85c-13.76 3-28 4.69-42.65 4.69v-27.38c1.69-12.62-7.64-36.26-22.63-51.25-6-6-9.37-14.14-9.37-22.63v-32.01c0-11.64-6.27-22.34-16.46-27.97-14.37-7.95-34.81-19.06-48.81-26.11-11.48-5.78-22.1-13.14-31.65-21.75l-.8-.72a114.792 114.792 0 0 1-18.06-20.74c-9.38-13.77-24.66-36.42-34.59-51.14 20.47-45.5 57.36-82.04 103.2-101.89l24.01 12.01C203.48 89.74 216 82.01 216 70.11v-11.3c7.99-1.29 16.12-2.11 24.39-2.42l28.3 28.3c6.25 6.25 6.25 16.38 0 22.63L264 112l-10.34 10.34c-3.12 3.12-3.12 8.19 0 11.31l4.69 4.69c3.12 3.12 3.12 8.19 0 11.31l-8 8a8.008 8.008 0 0 1-5.66 2.34h-8.99c-2.08 0-4.08.81-5.58 2.27l-9.92 9.65a8.008 8.008 0 0 0-1.58 9.31l15.59 31.19c2.66 5.32-1.21 11.58-7.15 11.58h-5.64c-1.93 0-3.79-.7-5.24-1.96l-9.28-8.06a16.017 16.017 0 0 0-15.55-3.1l-31.17 10.39a11.95 11.95 0 0 0-8.17 11.34c0 4.53 2.56 8.66 6.61 10.69l11.08 5.54c9.41 4.71 19.79 7.16 30.31 7.16s22.59 27.29 32 32h66.75c8.49 0 16.62 3.37 22.63 9.37l13.69 13.69a30.503 30.503 0 0 1 8.93 21.57 46.536 46.536 0 0 1-13.72 32.98zM417 274.25c-5.79-1.45-10.84-5-14.15-9.97l-17.98-26.97a23.97 23.97 0 0 1 0-26.62l19.59-29.38c2.32-3.47 5.5-6.29 9.24-8.15l12.98-6.49C440.2 193.59 448 223.87 448 256c0 8.67-.74 17.16-1.82 25.54L417 274.25z"></path>
          </svg>
        </a>
        </span>
        <span class="footericon" style="padding-right:4px; padding-left:4px">
          <a href="https://twitter.com/NBISwe"><svg style="height:0.8em;top:.04em;position:relative;fill:#bdbdbd;" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
        </svg>
        </a>
        </span>
        <span class="footericon" style="padding-left:4px">
          <a href="https://www.linkedin.com/company/nbisweden/">
            <svg style="height:0.8em;top:.04em;position:relative;fill:#bdbdbd;" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path>
            </svg>
        </a>
        </span>
    </div>
    </div>
  </div>
</footer>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
